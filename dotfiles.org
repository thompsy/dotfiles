#+TITLE: dotfiles.org

* Dotfiles
** What is this?
This is my dotfiles configuration in ~org-mode~. To output the source code run ~org-babel-tangle~
(typically ~C-c~ ~C-v~ ~t~). This will create and populate the various config files to the correct
locations.

Many (most!) things in this file have been inspired by others making their configuration
available. A few places that I've found particularly useful include:
- [[https://github.com/kwpav/dotfiles/blob/master/emacs.org][kwpav's config]]
- [[http://pages.sachachua.com/.emacs.d/Sacha.html][Sacha Chua's config]]
- [[https://github.com/TheBB/dotemacs][TheBB's config]]
- [[https://github.com/jwiegley/dot-emacs][jwiegly's config]]
- [[https://github.com/syl20bnr/spacemacs][Spacemacs]]
- [[https://github.com/hlissner/doom-emacs][Doom Emacs]]
- [[https://github.com/MatthewZMD/.emacs.d#org0f80f62][M-EMACS]]
- [[https://github.com/ianpan870102/yay-evil-emacs/blob/master/config.org][yay-evil]]
- [[https://framagit.org/steckerhalter/steckemacs.el/-/tree/master][steckemacs]]

* Tasks
** Zsh
*** TODO Add zshrc here
*** TODO Add Zellij here
*** TODO Homebrew
It would be good to auto install packages if on the Mac
** Config Updates
*** TODO Set correct buffer type when use Zellij's scroll to editor function
*** DONE Python encoding issues
:LOGBOOK:
- State "DONE"       from              [2024-01-11 Thu 14:42]
:END:
This is the error:
#+BEGIN_SRC
[stderr] Process EGLOT (arnold/(python-ts-mode python-mode)) stderr<1> finished
[stderr] Fatal Python error: config_get_locale_encoding: failed to get the locale encoding: nl_langinfo(CODESET) failed
[stderr] Python runtime state: preinitialized
#+END_SRC

This is the same error: https://stackoverflow.com/questions/60557160/python3-8-fails-with-fatal-python-error-config-get-locale-encoding

Possible solution from https://www.emacswiki.org/emacs/PythonProgrammingInEmacs:
#+BEGIN_SRC
(setenv "LC_CTYPE" "UTF-8")
(setenv "LC_ALL" "en_US.UTF-8")
(setenv "LANG" "en_US.UTF-8")
#+END_SRC
*** DONE Add a comment to all leader keys for hydra
:LOGBOOK:
- State "DONE"       from "TODO"       [2024-01-12 Fri 11:39]
:END:

*** TODO Setup spelling and easy usage
- https://codeberg.org/ideasman42/emacs-spell-fu
  - exclude specific faces. Looks good.
- https://github.com/redguardtoo/wucuo
*** DONE Spelling should deal with ordinals
:LOGBOOK:
- State "DONE"       from "TODO"       [2024-01-12 Fri 10:08]
:END:
e.g. 2nd, 3rd
*** DONE [#A] Minibuffer doesn't seem to be using history
:LOGBOOK:
- State "DONE"       from "TODO"       [2024-01-12 Fri 10:08]
:END:

*** DONE [#A] Use Flycheck instead of Flymake
:LOGBOOK:
- State "DONE"       from "TODO"       [2024-01-11 Thu 22:54]
:END:
Flycheck allows for different sources in parallel, e.g. ~gopls~ and ~golangci~.
See: https://github.com/intramurz/flycheck-eglot

*** TODO Experiment with ~treesit-font-lock-level~
*** TODO Explore ~transient-mark-mode~
See [[https://www.masteringemacs.org/article/fixing-mark-commands-transient-mark-mode]]
*** TODO Figure out a way to autoload treesitter grammars
It would also be good to keep these up to date.
*** DONE Have all hydras use q for quit
:LOGBOOK:
- State "DONE"       from "TODO"       [2024-01-12 Fri 11:39]
:END:

*** DONE Have ~project.el~ run the correct make target as compile command
:LOGBOOK:
- State "DONE"       from "TODO"       [2024-01-12 Fri 10:21]
:END:

*** TODO Corfu popup without hitting tab
- it might be nice to have this always popup with suggestions bars on the context e.g. Go, org etc. This might be Cape rather then Corfu
- this might be helpful https://emacs.stackexchange.com/questions/78237/automatic-popup-of-words-from-the-buffer-using-corfu-and-dabbrev
- this is useful context too https://www.reddit.com/r/emacs/comments/td0nth/sample_usage_of_cape_completion_at_point/
*** TODO Expore buffer placement options
See [[https://www.masteringemacs.org/article/demystifying-emacs-window-manager]]

** Org-mode
*** TODO Document tangling from the command line
See [[https://emacs.stackexchange.com/questions/27126/is-it-possible-to-org-bable-tangle-an-org-file-from-the-command-line]]
*** Tags
Ideas here:
- [[https://karl-voit.at/2022/01/29/How-to-Use-Tags/]]
- [[https://takeonrules.com/2024/01/06/leveraging-denotes-signature-for-multiple-purposes//]]
*** Workflows
Meetings:
- [[https://github.com/james-stoup/emacs-org-mode-tutorial]]

Other useful ideas here:
- [[https://dehora.net/journal/how-i-use-org-mode]]

** Packages to try
*** DONE ~urgrep~
:LOGBOOK:
- State "DONE"       from "TODO"       [2024-01-12 Fri 10:11]
:END:

*** TODO ~bookmarks+~
- we can bookmark buffers that aren't backed by files e.g. scratch
*** TODO ~wgrep~
*** TODO ~tresitter-context~
*** TODO ~explain-pause-mode~
*** TODO ~visible-mark-mode~
*** TODO ~hyperbole~
*** TODO Debugging with ~dape~
*** TODO ~org-sticky-header~
** Future Ideas
*** TODO Explore these configs
- [[https://old.reddit.com/r/emacs/comments/ehjcu2/screenshot_polishing_my_emacs_who_said_an_old/]]
- [[https://kristofferbalintona.me/posts/202202211546/]]
  - good ideas with Vertico etc here
- [[https://kristofferbalintona.me/posts/202202270056/]]
  - Corfu related config
- [[https://protesilaos.com/emacs/dotemacs]]
*** TODO Explore ~embark~ more

* Emacs
** Local
:PROPERTIES:
:ID:       A9EE2453-8D16-484B-AF4A-D212F0B6F4FE
:END:
These are various, installation specific settings that might differ across machines, some of which I
don't want to commit to Git.

#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/local.el" :eval no :mkdirp yes
  (provide 'local-setup)

  (setq user-full-name "Andrew Thompson"
        user-mail-address "github@downthewire.co.uk")

  ;; Use this everywhere
  (defconst my/org-dir
    "~/notebook/")

  (defconst my/org-agenda-files
    (list my/org-dir))
#+END_SRC

** Early Init
:PROPERTIES:
:ID:       9C54903A-53BB-4D29-90A5-9ED43A95F3DE
:END:
The ~early-init.el~ file is called very early in the initialisation process, so this is a good point
to disable ~package.el~ in favour of ~straight.el~.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/early-init.el" :eval no
  ;; Startup speed, annoyance suppression
  (setq gc-cons-threshold 10000000)
  (setq byte-compile-warnings '(not obsolete))
  (setq warning-suppress-log-types '((comp) (bytecomp)))
  (setq native-comp-async-report-warnings-errors 'silent)

  ;; Silence stupid startup message
  (setq inhibit-startup-echo-area-message (user-login-name))

  ;; Default frame configuration: full screen, good-looking title bar on macOS
  (setq frame-resize-pixelwise t)
  (tool-bar-mode -1)                      ; All these tools are in the menu-bar anyway
  (setq default-frame-alist '((fullscreen . maximized)

  			    ;; You can turn off scroll bars by uncommenting these lines:
  			    (vertical-scroll-bars . nil)
  			    (horizontal-scroll-bars . nil)

  			    ;; Setting the face in here prevents flashes of
  			    ;; color as the theme gets activated
  			    (background-color . "#000000")
  			    (ns-appearance . dark)
  			    (ns-transparent-titlebar . t)))

  ;; Disable the default package manager so we can use straight.el later
  (setq package-enable-at-startup nil)
#+END_SRC

** Preamble
:PROPERTIES:
:ID:       C189F4FE-CACC-4BE4-BBCE-BC1D44D6653E
:END:
Some initial comment blurb.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  ;;; init.el --- Initialization file for Emacs
  ;;; Commentary: Emacs Startup File --- initialization for Emacs
  ;;; Code:
#+END_SRC

Load some local setup. As noted above, this is generally installation specific, so its easiest to
keep it in a separate file.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (require 'local-setup "~/.emacs.d/local.el")
#+END_SRC

** Package Manager
:PROPERTIES:
:ID:       B3B9D84C-661E-457F-9282-421A1B12060E
:END:
Setup the [[https://github.com/radian-software/straight.el][~straight.el~]] package manager.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (setq straight-repository-branch "master")

  (defvar bootstrap-version)
  (let ((bootstrap-file
         (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
        (bootstrap-version 5))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
          (url-retrieve-synchronously
           "https://raw.githubusercontent.com/raxod502/straight.el/develop/install.el"
           'silent 'inhibit-cookies)
        (goto-char (point-max))
        (eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))
#+END_SRC

From the straight docs:
#+BEGIN_QUOTE
By setting the variable straight-cache-autoloads to a non-nil value, you can cause straight.el to
cache the autoloads of all used packages in a single file on disk, and load them from there instead
of from the individual package files if they are still up to date. This reduces the number of disk
IO operations during startup from O(number of packages) to O(1), so it should improve
performance. No other configuration should be necessary to make this work; however, you may wish to
call straight-prune-build occasionally, since otherwise this cache file may grow quite large over
time.
#+END_QUOTE
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (setq straight-cache-autoloads t)
#+END_SRC

In addition:
#+BEGIN_QUOTE
You may customize straight-use-package-by-default to make it so that :straight t is assumed unless
you explicitly override it with :straight nil.
#+END_QUOTE

#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (setq straight-use-package-by-default t)
#+END_SRC

todo: update this link
Install [[https://github.com/jwiegley/use-package][~use-package~]] for easily installing other packages.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  ;; Install use-package to use with straight.el
  (straight-use-package 'use-package)
#+END_SRC

I don't want to use the built-in version of org-mode since it's usually pretty old. Instead I want
straight to pull down the latest version. To avoid the built-in version getting loaded we need to
explicitly load it with straight early in the init process. See more details in the [[https://github.com/radian-software/straight.el#the-wrong-version-of-my-package-was-loaded][~README.md~]].
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (straight-use-package 'org)
#+END_SRC

#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (setq use-package-always-demand t)
#+END_SRC
** Core Configuration
:PROPERTIES:
:ID:       58236767-8AD4-4A25-A2A9-02BDEDC9E6D4
:END:
A few miscellaneous settings. Note that emacs is not really a package strictly speaking which is why we include ~:straight nil~ so that our package manager doesn't try to fetch the source.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
    (use-package emacs
      :straight nil
      :init
      ;; answer with y/n instead of typing out yes/no
      (defalias 'yes-or-no-p 'y-or-n-p)
      :config
      (setq indent-tabs-mode nil
            tab-width 4
            show-trailing-whitespace t
            fill-column 100)
      (setq-default indent-tabs-mode nil
                    fill-column 100)
      (setopt sentence-end-double-space nil
              display-time-default-load-average nil)
      :custom
      ;; load new source files instead of stale elisp bytecode
      (load-prefer-newer t)
      ;; allow emacs to be any size, removes black bars
      (frame-resize-pixelwise t))
#+END_SRC

It's useful to have buffers auto-revert when files on disk change especially when using Git branches a lot!
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package autorevert
    :straight nil
    :custom
    (global-revert-check-vc-info t)
    :config
    (global-auto-revert-mode +1)
    ;; Automatically reread from disk if the underlying file changes
    (setopt auto-revert-avoid-polling t)
    ;; Some systems don't do file notifications well; see
    ;; https://todo.sr.ht/~ashton314/emacs-bedrock/11
    (setopt auto-revert-interval 5)
    (setopt auto-revert-check-vc-info t))
#+END_SRC

Use the system keyboard when killing and yanking.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package simple
    :straight nil
    :custom
    ;; killing and yanking uses the system clipboard
    (save-interprogram-paste-before-kill t))
#+END_SRC

[[https://github.com/emacs-mirror/emacs/blob/master/lisp/saveplace.el][~saveplace~]] jumps back to
the last when later visiting a file. This is handy to pick up where you left off.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package saveplace
    :straight nil
    :config
    (save-place-mode +1))
#+END_SRC

[[https://github.com/emacscollective/no-littering][~no-littering~]] keeps configuration files and
other persistent data under ~user-emacs-directory~ rather than spamming them in inconsistent places.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package no-littering
    :init
    (setq no-littering-etc-directory
          (expand-file-name "etc/" user-emacs-directory)
          no-littering-var-directory
          (expand-file-name "var/" user-emacs-directory)))
#+END_SRC

Use a separate custom file to remove auto-generated code from ~init.el~. This should be loaded prior
to any themes so that they confirmation code gets stored in ~custom.el~.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package cus-edit
    :straight nil
    :custom
    (custom-file (expand-file-name "custom.el" user-emacs-directory))
    :config
    (if (file-exists-p custom-file)
        (load-file custom-file)))
#+END_SRC

*** Exec Path Setup
:PROPERTIES:
:ID:       0C607D19-2464-4AC0-8FDC-BB6A2420ED3F
:END:
[[https://github.com/purcell/exec-path-from-shell][~exec-path-from-shell~]] loads the ~PATH~ from your shell setup. This is useful when running Emacs from
a non-shell environment like OSX.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package exec-path-from-shell
    :config
    (exec-path-from-shell-initialize))
#+END_SRC

*** Files
:PROPERTIES:
:ID:       A2401A62-B9F5-4A39-8C9B-9BEE0ECCEC17
:END:
Setup some basic file hygiene. Keep some backup files around, but keep them out of sight.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package files
    :straight nil
    :init
    (recentf-mode 1)
    :config
    (setq backup-by-copying t
          backup-directory-alist '((".*" . "~/.emacs.d/backups/"))
          delete-old-versions t
          delete-auto-save-files t
          kept-new-versions 6
          kept-old-versions 2
          version-control t
          vc-make-backup-files t
          recentf-max-menu-items 25
          recentf-max-saved-items 500
          create-lockfiles nil
          auto-save-file-name-transforms
          `((".*" "~/.emacs.d/auto-saves/" t))))
#+END_SRC

Use UTF-8 everywhere.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package mule
    :straight nil
    :config
    (prefer-coding-system 'utf-8-unix)
    (set-default-coding-systems 'utf-8-unix)
    (set-language-environment 'utf-8)
    (set-terminal-coding-system 'utf-8-unix)
    (setq locale-coding-system 'utf-8-unix)
    (set-selection-coding-system 'utf-8-unix)
    (setenv "LC_CTYPE" "UTF-8")
    (setenv "LC_ALL" "en_US.UTF-8")
    (setenv "LANG" "en_US.UTF-8"))
#+END_SRC

~uniqify~ renames buffers with the same name so that they're easier to distinguish.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package uniquify
    :straight nil
    :config
    (setq uniquify-buffer-name-style 'forward
          uniquify-separator "/"
          ;; rename after killing uniquified
          uniquify-after-kill-buffer-p t
          ;; don't muck with special buffers
          uniquify-ignore-buffers-re "^\\*"))
#+END_SRC

*** Discoverability
:PROPERTIES:
:ID:       97DB78E1-C522-4A0E-9AC2-6FBA15253B26
:END:
[[https://github.com/justbur/emacs-which-key][~which-key~]] displays all of the available keybindings following a incompletely entered command. For
example, pressing ~C-x~ and waiting a moment will cause ~which-key~ to populate the minibuffer with all
the available next keys along with their corresponding commands. This makes discovery of new
commands very easy.

The only slight issue with this is that the size of the minibuffer expands a lot which can cause the
view of the current buffer to change depending on where the point is. ~which-key-posframe~ provides an
improvement on this by popping up in a floating window. I'll try it for a while and see.

#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package which-key
    :custom
    (which-key-idle-delay 0)
    :config
    (which-key-mode +1))
#+END_SRC

*** Savehist
:PROPERTIES:
:ID:       C7C96A0A-E6EA-4FB1-BD24-9E83A8F7761C
:END:
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  ;; Save history of minibuffer
  (savehist-mode)
  (setq savehist-additional-variables '(kill-ring search-ring regexp-search-ring))
#+END_SRC

*** Inteface Enhancements
:PROPERTIES:
:ID:       2D0FB78A-3A47-4707-A038-6DD3FCF03DE3
:END:
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  ;; Mode line information
  (setopt line-number-mode t)                        ; Show current line in modeline
  (setopt column-number-mode t)                      ; Show column as well

  (setopt x-underline-at-descent-line nil)           ; Prettier underlines
  (setopt switch-to-buffer-obey-display-actions t)   ; Make switching buffers more consistent

  (setopt indicate-buffer-boundaries 'left)  ; Show buffer top and bottom in the margin

  ;; Enable horizontal scrolling
  (setopt mouse-wheel-tilt-scroll t)
  (setopt mouse-wheel-flip-direction t)

  ;; Misc. UI tweaks
  (blink-cursor-mode -1)                                ; Steady cursor
  (pixel-scroll-precision-mode)                         ; Smooth scrolling

  ;; Display line numbers in programming mode
  (add-hook 'prog-mode-hook 'display-line-numbers-mode)
  (setopt display-line-numbers-width 3)           ; Set a minimum width

  ;; Nice line wrapping when working with text
  (add-hook 'text-mode-hook 'visual-line-mode)

  ;; Modes to highlight the current line with
  (let ((hl-line-hooks '(text-mode-hook prog-mode-hook)))
    (mapc (lambda (hook) (add-hook hook 'hl-line-mode)) hl-line-hooks))
#+END_SRC

** Aesthetics
:PROPERTIES:
:ID:       6984A6E9-A3A7-4673-8A6A-64E17B687898
:END:
Turn off a bunch of frame related functionality for a more minimal experience.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package frame
    :straight nil
    :config
    (blink-cursor-mode -1)
    (setq initial-scratch-message ""
          inhibit-startup-message t
          visible-bell nil
          ring-bell-function 'ignore
          initial-frame-alist
          '((menu-bar-lines . 0)
            (tool-bar-lines . 0)))
    (scroll-bar-mode 0)
    (tool-bar-mode 0)
    (menu-bar-mode 0)
    (global-hl-line-mode 1))
#+END_SRC

[[https://draculatheme.com/emacs][Dracula]] is a nice theme that's available for lots of apps.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package dracula-theme
    :config
    (load-theme 'dracula))

  (add-to-list 'default-frame-alist '(font . "Fira Code-14"))

  (use-package all-the-icons)

  (use-package all-the-icons-completion
    :init
    (all-the-icons-completion-mode))
#+END_SRC

[[https://github.com/seagle0128/doom-modeline][~doom-modeline~]] is a fancy, fast and minimal mode-line. This required running ~M-x nerd-icons-install-fonts~ to install the required icon font.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package doom-modeline
    :demand t
    :init
    (column-number-mode +1)
    (doom-modeline-mode +1)
    :config
    (setq doom-modeline-height 1)
    (set-face-attribute 'mode-line nil :height 150)
    (set-face-attribute 'mode-line-inactive nil :height 150)
    :custom
    (doom-modeline-vcs-max-length 50)
    (doom-modeline-buffer-file-name-style 'truncate-upto-project))
#+END_SRC

** Keybindings
:PROPERTIES:
:ID:       55DF7803-F4D1-43ED-B5EC-F4377C20B52B
:END:
[[https://github.com/noctuid/general.el][~general.el~]] provides a convenient method for binding
keys. It also integrates well with ~use-package~. In particular, this allows us to easily setup a
global leader key, ~my-leader-def~ and chain bindings from that.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package general
    :custom
    (general-override-states '(insert emacs hybrid normal visual motion operator replace))
    :config
    (general-define-key
     "C-w" 'backward-kill-word
     "C-c C-k" 'kill-region
     "C-x C-k" 'kill-region
     "C-x C-m" 'execute-extended-command
     "C-x m" 'execute-extended-command
     "C-c C-m" 'execute-extended-command
     "C-c m" 'execute-extended-command
     ;; Taken from https://www.irreal.org/blog/?p=10424:
     "C-x t" 'beginning-of-buffer
     "C-x e" 'end-of-buffer
     )

    ;; Make general's keybindings take precedence over keys bound to other minor mode keymaps.
    (general-override-mode)

    ;; We need to call this so that we can allocate C-t as a prefix key. See
    ;; https://github.com/noctuid/general.el#automatic-key-unbinding for details.
    (general-auto-unbind-keys)
    ;; Create a definer where most of my commands will live under
    (general-create-definer my-leader-def
      :prefix "C-t")
    ;; Setup some initial bindings.
    ;; TODO some of these should probably live elsewhere
    (my-leader-def
      "m" '(execute-extended-command :wk "exec")
      "a" 'org-agenda
      "b" '(:ignore t :wk "bookmarks")
      "bs" 'bookmark-set
      "bl" 'list-bookmarks
      "bj" 'consult-bookmark
      ;; quit / restart
      "q" '(:ignore t :wk "quit")
      "qq" 'save-buffers-kill-terminal
      "qQ" 'save-buffers-kill-emacs
      "qr" 'restart-emacs))
#+END_SRC

[[https://github.com/Fuco1/free-keys][~free-keys~]] shows unused key bindings.
#+begin_src emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package free-keys)
#+end_src

*** Hydra
:PROPERTIES:
:ID:       1845AD20-50EC-468B-99C6-19808C288DF1
:END:
[[https://github.com/abo-abo/hydra][~hydra~]] allows us to specify related keybindings together in a
neat way. Note that ~:wk~ allows us to specify the text that is displayed by ~which-key~ for this hydra.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package hydra)

  ;; This allows us to use :hydra within use-package
  (use-package use-package-hydra)
#+END_SRC

This hydra provides easy access to various package management commands.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (my-leader-def "P" '(hydra-straight-helper/body :wk "pkgs"))
  (defhydra hydra-straight-helper (:hint nil :color green)
    "
        _c_heck all       |_f_etch all     |_m_erge all      |_n_ormalize all   |p_u_sh all
        _C_heck package   |_F_etch package |_M_erge package  |_N_ormlize package|p_U_sh package
        ----------------^^+--------------^^+---------------^^+----------------^^+------------||_q_uit||
        _r_ebuild all     |_p_ull all      |_v_ersions freeze|_w_atcher start   |_g_et recipe
        _R_ebuild package |_P_ull package  |_V_ersions thaw  |_W_atcher quit    |prun_e_ build"
    ("c" straight-check-all)
    ("C" straight-check-package)
    ("r" straight-rebuild-all)
    ("R" straight-rebuild-package)
    ("f" straight-fetch-all)
    ("F" straight-fetch-package)
    ("p" straight-pull-all)
    ("P" straight-pull-package)
    ("m" straight-merge-all)
    ("M" straight-merge-package)
    ("n" straight-normalize-all)
    ("N" straight-normalize-package)
    ("u" straight-push-all)
    ("U" straight-push-package)
    ("v" straight-freeze-versions)
    ("V" straight-thaw-versions)
    ("w" straight-watcher-start)
    ("W" straight-watcher-quit)
    ("g" straight-get-recipe)
    ("e" straight-prune-build)
    ("q" nil))
#+END_SRC

This hydra gives easy access to inserting various Unicode characters.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (defun my/insert-unicode (unicode-name)
    "Same as C-x 8 enter UNICODE-NAME."
    (insert-char (gethash unicode-name (ucs-names))))

  (my-leader-def "u" '(hydra-unicode/body :wk "unicode"))
  (defhydra hydra-unicode (:hint nil)
    "
          Unicode  _e_ €  _g_ £
                   _f_ ♀  _r_ ♂
                   _o_ °  _m_ µ  _z_ ë  _Z_ Ë
                   _n_ ←  _e_ ↓  _i_ ↑  _o_ →
          "
    ("e" (my/insert-unicode "EURO SIGN"))
    ("g" (my/insert-unicode "POUND SIGN"))

    ("r" (my/insert-unicode "MALE SIGN"))
    ("f" (my/insert-unicode "FEMALE SIGN"))

    ("o" (my/insert-unicode "DEGREE SIGN"))
    ("m" (my/insert-unicode "MICRO SIGN"))

    ("z" (my/insert-unicode "LATIN SMALL LETTER E DIAERESIS"))
    ("Z" (my/insert-unicode "LATIN CAPITAL LETTER E DIAERESIS"))

    ("n" (my/insert-unicode "LEFTWARDS ARROW"))
    ("e" (my/insert-unicode "DOWNWARDS ARROW"))
    ("i" (my/insert-unicode "UPWARDS ARROW"))
    ("o" (my/insert-unicode "RIGHTWARDS ARROW")))
#+END_SRC

[[https://www.emacswiki.org/emacs/download/zoom-frm.el][~zoom-frm~]] is a nice way to zoom in and out on a frame basis. This is useful when switching from
smaller to larger screens.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package zoom-frm
    :general
    (my-leader-def "z" '(hydra-zoom/body :wk "zoom"))
    :hydra (hydra-zoom (:column 2)
                       ("n" zoom-frm-in "Zoom in")
                       ("t" zoom-frm-out "Zoom out")
                       ("r" (text-scale-set 0) "Reset zoom")
                       ("0" (text-scale-set 0) :bind nil :exit t)
                       ("q" nil "quit")))
#+END_SRC

** Navigation
*** Avy
:PROPERTIES:
:ID:       6CBC9104-AD62-4843-8C69-EB2223F5903D
:END:
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package avy
    :demand t
    :config (setq avy-background t
      		avy-keys '(
      			   ?a ?r ?s ?t ?g ?m ?n ?e ?i ?o
      			   ?z ?x ?c ?d ?v ?k ?h ?, ?.
      			   ?q ?w ?f ?p ?b ?j ?l ?u ?'))
    :general ("C-'" 'avy-goto-char-timer))
#+END_SRC

*** Consult
:PROPERTIES:
:ID:       49DCD1B7-C7DE-4D49-8E47-D194614FA7EB
:END:
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package embark-consult
    :after (embark consult))

  ;; Consult: Misc. enhanced commands
  (use-package consult
    :general
    ("C-c M-x" 'consult-mode-command)
    ("C-c h" 'consult-history)
    ("C-c k" 'consult-kmacro)
    ("C-c m" 'consult-man)
    ("C-c i" 'consult-info)
    ;; Drop-in replacements
    ("M-y"   'consult-yank-from-kill-ring)   ;; orig. yank-pop
    ("M-g g" 'consult-goto-line)
    ("C-x b" 'consult-buffer)                ;; orig. switch-to-buffer
    ("C-x r b" 'consult-bookmark)            ;; orig. bookmark-jump
    ("C-x p b" 'consult-project-buffer)      ;; orig. project-switch-to-buffer
    ;; M-g bindings in `goto-map'
    ("M-g e" 'consult-compile-error)
    ("M-g f" 'consult-flycheck)              ;; Alternative: consult-flymake
    ("M-g g" 'consult-goto-line)             ;; orig. goto-line
    ("M-g M-g" 'consult-goto-line)           ;; orig. goto-line
    ("M-g o" 'consult-outline)               ;; Alternative: consult-org-heading
    ("M-g m" 'consult-mark)
    ("M-g k" 'consult-global-mark)
    ("M-g i" 'consult-imenu)
    ("M-g I" 'consult-imenu-multi)
    ;; M-s bindings in `search-map'
    ("M-s d" 'consult-find)                  ;; Alternative: consult-fd
    ("M-s c" 'consult-locate)
    ("M-s g" 'consult-grep)
    ("M-s G" 'consult-git-grep)
    ("M-s r" 'consult-ripgrep)
    ("M-s l" 'consult-line)
    ("M-s L" 'consult-line-multi)
    ("M-s k" 'consult-keep-lines)
    ("M-s u" 'consult-focus-lines)
    ;; Isearch integration
    ("M-s e" 'consult-isearch-history)
    (:keymaps 'isearch-mode-map
    	    "M-e" 'consult-isearch-history   ;; orig. isearch-edit-string
    	    "M-s e" 'consult-isearch-history ;; orig. isearch-edit-string
    	    "M-s l" 'consult-line            ;; needed by consult-line to detect isearch
    	    "M-s L" 'consult-line-multi)     ;; needed by consult-line to detect isearch
    ;; Minibuffer history
    (:keymaps 'minibuffer-local-map
    	    "M-s" 'consult-history)          ;; orig. next-matching-history-element
    :config
    ;; Narrowing lets you restrict results to certain groups of candidates
    (setq consult-narrow-key "<")

    ;; set manual preview for result that will require a disk read
    (consult-customize
     consult-ripgrep consult-git-grep consult-grep
     consult-bookmark consult-recent-file consult-xref
     consult--source-bookmark consult--source-file-register
     consult--source-recent-file consult--source-project-recent-file
     ;; :preview-key '(:debounce 0.4 any) ;; Option 1: Delay preview
     :preview-key "M-.")            ;; Option 2: Manual preview
    :init
    ;; Use Consult to select xref locations with preview
    (setq xref-show-xrefs-function #'consult-xref
          xref-show-definitions-function #'consult-xref)
    )

  (use-package consult-project-extra
    :straight t
    :general
    ("C-x p f" 'consult-project-extra-find)
    ("C-x p o" 'consult-project-extra-find-other-window))

  (use-package consult-dir
    :after vertico
    :general
    ("C-x C-d" 'consult-dir)
    (:keymaps 'vertico-map
              "C-x C-d" 'consult-dir
              "C-x C-j" 'consult-dir-jump-file))

  (use-package embark
    :demand t
    :after avy
    :general ("C-c a" 'embark-act)        ; bind this to an easy key to hit
    :init
    ;; Add the option to run embark when using avy
    (defun bedrock/avy-action-embark (pt)
      (unwind-protect
      	(save-excursion
      	  (goto-char pt)
      	  (embark-act))
        (select-window
         (cdr (ring-ref avy-ring 0))))
      t)

    ;; After invoking avy-goto-char-timer, hit "." to run embark at the next
    ;; candidate you select
    (setf (alist-get ?. avy-dispatch-alist) 'bedrock/avy-action-embark))
#+END_SRC

*** Minibuffer
:PROPERTIES:
:ID:       2510CFE9-62F4-451B-8971-1CF2452B4A87
:END:
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  ;; For help, see: https://www.masteringemacs.org/article/understanding-minibuffer-completion
  (setopt completion-cycle-threshold 1)                  ; TAB cycles candidates
  (setopt completions-detailed t)                        ; Show annotations
  (setopt tab-always-indent 'complete)                   ; When I hit TAB, try to complete, otherwise, indent

  (setopt completion-auto-help 'always)                  ; Open completion always; `lazy' another option
  (setopt completions-max-height 20)                     ; This is arbitrary
  (setopt completions-detailed t)
  (setopt completions-format 'one-column)
  (setopt completions-group t)
  (setopt completion-auto-select 'second-tab)            ; Much more eager

  (keymap-set minibuffer-mode-map "TAB" 'minibuffer-complete) ; TAB acts more like how it does in the shell

  ;; Vertico: better vertical completion for minibuffer commands
  (use-package vertico
    :init
    ;; You'll want to make sure that e.g. fido-mode isn't enabled
    (vertico-mode))

  (use-package vertico-directory
    :straight nil
    :after vertico
    :general (:keymaps 'vertico-map
    	      "C-j" 'vertico-directory-enter
    	      "C-l" 'vertico-directory-up
    	      "DEL" 'vertico-directory-delete-char
    	      "M-DEL" 'vertico-directory-delete-word))

  ;; Marginalia: annotations for minibuffer
  (use-package marginalia
    :config
    (marginalia-mode))
#+END_SRC

*** Completion
:PROPERTIES:
:ID:       C4C77C86-7E03-4C26-92D9-8A909D35A157
:END:
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  ;; Popup completion-at-point
  (use-package corfu
    :straight (:files (:defaults "extensions/*"))
    :init
    (global-corfu-mode)
    :general
    (:keymaps 'corfu-map
      	"SPC" 'corfu-insert-separator
      	"C-n" 'corfu-next
      	"C-p" 'corfu-previous))

  ;; Part of corfu
  (use-package corfu-popupinfo
    :straight nil
    :after corfu
    :hook (corfu-mode . corfu-popupinfo-mode)
    :custom
    (corfu-popupinfo-delay '(0.25 . 0.1))
    (corfu-popupinfo-hide nil)
    :config
    (corfu-popupinfo-mode))

  ;; Make corfu popup come up in terminal overlay
  (use-package corfu-terminal
    :if (not (display-graphic-p))
    :config
    (corfu-terminal-mode))

  ;; Fancy completion-at-point functions; there's too much in the cape package to
  ;; configure here; dive in when you're comfortable!
  (use-package cape
    :init
    (add-to-list 'completion-at-point-functions #'cape-dabbrev)
    (add-to-list 'completion-at-point-functions #'cape-file))

  ;; Pretty icons for corfu
  (use-package kind-icon
    :if (display-graphic-p)
    :after corfu
    :config
    (add-to-list 'corfu-margin-formatters #'kind-icon-margin-formatter))

  (use-package eshell
    :init
    (defun bedrock/setup-eshell ()
      ;; Something funny is going on with how Eshell sets up its keymaps; this is
      ;; a work-around to make C-r bound in the keymap
      (keymap-set eshell-mode-map "C-r" 'consult-history))
    :hook ((eshell-mode . bedrock/setup-eshell)))

  ;; Orderless: powerful completion style
  (use-package orderless
    :config
    (setq completion-styles '(orderless)))
#+END_SRC

*** Bookmarks
:PROPERTIES:
:ID:       07C52099-B065-485D-A22A-832A8E471A76
:END:
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  ;; disable annoying bookmark icons
  (setq bookmark-fringe-mark nil)

  (use-package dogears
    :general
    (my-leader-def
      "e" '(hydra-dogears/body :wk "dogears"))
    ("M-g d" 'dogears-go)
    ("M-g M-b" 'dogears-back)
    ("M-g M-f" 'dogears-forward)
    ("M-g M-d" 'dogears-list)
    :config
    (setq dogears-idle 2
          dogears-limit 300)
    (add-to-list 'dogears-functions 'kill-ring-save)
    ;;(add-hook 'dogears-hooks 'after-change-functions)
    (dogears-mode)
    :hydra (hydra-dogears (:column 2)
                          ("p" dogears-back "Back")
                          ("n" dogears-forward "Forward")
                          ("g" dogears-go "Go" :exit t)
                          ("l" dogears-list "List: ":bind nil :exit t)
                          ("q" nil "quit")))
#+END_SRC

*** Help
:PROPERTIES:
:ID:       7CAA4640-4E86-436F-B058-2BC5FF7A2CBF
:END:
[[https://github.com/Wilfred/helpful][~helpful~]] provides a slightly nicer interface to the built-in help files.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package helpful
    :general
    ("C-h f" 'helpful-callable)
    ("C-h F" 'helpful-function)
    ("C-h M" 'helpful-macro)
    ("C-h x" 'helpful-command)
    ("C-h k" 'helpful-key)
    ("C-h v" 'helpful-variable)
    ("C-h C-d" 'helpful-at-point))
#+END_SRC
** Filesystem
*** Dired
:PROPERTIES:
:ID:       39BCEA77-6E29-467F-AC8D-0A2C332EA43D
:END:
~dired~ is basically a file explorer.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package dired
    :straight nil
    :defer t
    :general
    (my-leader-def "d" 'dired)
    (dired-mode-map "c" 'dired-do-copy)
    (dired-mode-map "r" 'dired-do-rename)
    (dired-mode-map "." 'hydra-dired/body)
    :hydra
    (hydra-dired (:hint nil :color pink)
                 "
  _+_ mkdir          _v_iew           _m_ark             _(_ details        _i_nsert-subdir    wdired
  _c_opy             _O_ view other   _U_nmark all       _)_ omit-mode      _$_ hide-subdir    C-x C-q : edit
  _D_elete           _o_pen other     _u_nmark           _l_ redisplay      _w_ kill-subdir    C-c C-c : commit
  _r_ename           _M_ chmod        _t_oggle           _g_ revert buf     _e_ ediff          C-c ESC : abort
  _Y_ rel symlink    _G_ chgrp        _E_xtension mark   _s_ort             _=_ pdiff
  _S_ymlink          ^ ^              _F_ind marked      _._ toggle hydra   \\ flyspell
  _R_sync            ^ ^              ^ ^                ^ ^                _?_ summary
  _z_ compress-file  _A_ find regexp
  _Z_ compress       _Q_ repl regexp
  T - tag prefix
  "
                 ("\\" dired-do-ispell)
                 ("(" dired-hide-details-mode)
                 (")" dired-omit-mode)
                 ("+" dired-create-directory)
                 ("=" diredp-ediff)         ;; smart diff
                 ("?" dired-summary)
                 ("$" diredp-hide-subdir-nomove)
                 ("A" dired-do-find-regexp)
                 ("c" dired-do-copy)        ;; Copy all marked files
                 ("D" dired-do-delete)
                 ("E" dired-mark-extension)
                 ("e" dired-ediff-files)
                 ("F" dired-do-find-marked-files)
                 ("G" dired-do-chgrp)
                 ("g" revert-buffer)        ;; read all directories again (refresh)
                 ("i" dired-maybe-insert-subdir)
                 ("l" dired-do-redisplay)   ;; relist the marked or singel directory
                 ("M" dired-do-chmod)
                 ("m" dired-mark)
                 ("O" dired-display-file)
                 ("o" dired-find-file-other-window)
                 ("Q" dired-do-find-regexp-and-replace)
                 ("r" dired-do-rename)
                 ("R" dired-do-rsynch)
                 ("S" dired-do-symlink)
                 ("s" dired-sort-toggle-or-edit)
                 ("t" dired-toggle-marks)
                 ("U" dired-unmark-all-marks)
                 ("u" dired-unmark)
                 ("v" dired-view-file)      ;; q to exit, s to search, = gets line #
                 ("w" dired-kill-subdir)
                 ("Y" dired-do-relsymlink)
                 ("z" diredp-compress-this-file)
                 ("Z" dired-do-compress)
                 ("q" nil)
                 ("." nil :color blue)))

  ;; Colourful columns.
  (use-package diredfl
    :after dired
    :config
    (diredfl-global-mode +1))

  (use-package dired-git-info
    :config
    (setq dgi-auto-hide-details-p nil)
    (add-hook 'dired-after-readin-hook 'dired-git-info-auto-enable))

  (use-package all-the-icons-dired
    :after all-the-icons
    :config
    (add-hook 'dired-mode-hook 'all-the-icons-dired-mode))
#+END_SRC
** Editing
*** Undo
:PROPERTIES:
:ID:       B74C61C8-46C8-4BCB-BCCB-AE63283C1C5C
:END:
[[https://github.com/emacsmirror/undo-fu][~undo-fu~]] improves the default undo experience.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package undo-fu
    :general
    ("C-z" 'undo-fu-only-undo)
    ("C-S-z" 'undo-fu-only-redo))
#+END_SRC

[[https://github.com/casouri/vundo][~vundo~]] displays a nice braching undo tree built on top of the default undo system.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package vundo
    :config
    ;; use a nicer unicode font to display the tree
    (setq vundo-glyph-alist vundo-unicode-symbols))
#+END_SRC
*** Fill/Unfill Paragraph
:PROPERTIES:
:ID:       AD567D1B-47AC-456E-A711-87039063F48C
:END:
[[https://github.com/purcell/unfill][~unfill~]] is an ideal little helper function to Emacs'
built-in ~fill~ function.
#+begin_src emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package unfill
    :general
    ("M-q" 'unfill-toggle))
#+end_src
*** Spelling
:PROPERTIES:
:ID:       05DF5D12-0C29-44DD-88A5-F25762BC4F85
:END:
~flyspell~ is Emacs' spelling mode. I've added a decent hydra here for convenience.

If I miss-spell something I can hit ~C-;~ and it will auto correct the previous word even if it's a
few words back.

What's the workflow that I want here? Two fold:
1. spell as I type and correct works as I go. ~C-;~ is adequate for this, except I can't add to dictionary from there easily. Maybe the flyspell-correct package could help here.
2. batch spell a buffer or region. The ~ispell~ interface is probably OK for this.
 #+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
   (setenv "LANG" "en_GB")
   (use-package flyspell
     :general
     (my-leader-def
       "s" '(hydra-spelling/body :wk "spell"))
     :hook ((prog-mode . flyspell-prog-mode)
            ((org-mode text-mode) . flyspell-mode))
     :config
     ;;TODO add this to :hook instead maybe in the org use-package
     (add-hook 'org-mode-hook #'at/org-ispell)
     (setq ispell-dictionary "en_GB"
           ispell-local-dictionary "en_GB"
           ispell-current-dictionary "en_GB"
           ispell-program-name "hunspell"
           ispell-silently-savep t
           ispell-personal-dictionary "~/.emacs.d/.aspell.en.pws"
           )
     :hydra (hydra-spelling (:color blue :hint nil)
                            "
            ^
            ^Spelling^          ^Errors^            ^Checker^
            ^────────^──────────^──────^────────────^───────^───────
            _q_ quit            _<_ previous        _c_ correction
            ^^                  _>_ next            _d_ dictionary
            ^^                  _f_ check           _m_ mode
            ^^                  ^^                  ^^
            "
                            ("q" nil)
                            ("<" flyspell-correct-previous :color pink)
                            (">" flyspell-correct-next :color pink)
                            ("c" ispell)
                            ("d" ispell-change-dictionary)
                            ("f" flyspell-buffer)
                            ("m" flyspell-mode)))



   ;; Taken from: https://endlessparentheses.com/ispell-and-org-mode.html
   (defun at/org-ispell ()
     "Configure `ispell-skip-region-alist' for `org-mode'."
     (make-local-variable 'ispell-skip-region-alist)
     (add-to-list 'ispell-skip-region-alist '(org-property-drawer-re))
     (add-to-list 'ispell-skip-region-alist '(org-logbook-drawer-re))
     (add-to-list 'ispell-skip-region-alist '("~" "~"))
     (add-to-list 'ispell-skip-region-alist '("=" "="))
     (add-to-list 'ispell-skip-region-alist '(org-babel-src-block-regexp))
     (add-to-list 'ispell-skip-region-alist '("^#\\+BEGIN_SRC" "^#\\+END_SRC"))
     (add-to-list 'ispell-skip-region-alist '("^#\\+BEGIN_SRC" "^#\\+END_SRC"))
     )


   ;;(use-package flyspell-correct
   ;;  :after flyspell)

   (use-package consult-flyspell
     :after (flyspell consult))

   ;; bundle this config together
   ;; From: https://codeberg.org/ideasman42/emacs-spell-fu
   ;; (use-package spell-fu)

   ;; (add-hook 'org-mode-hook
   ;;           (lambda ()
   ;;             (setq spell-fu-faces-exclude
   ;;                   '(org-block-begin-line
   ;;                     org-block-end-line
   ;;                     org-code
   ;;                     org-date
   ;;                     org-drawer org-document-info-keyword
   ;;                     org-ellipsis
   ;;                     org-link
   ;;                     org-meta-line
   ;;                     org-properties
   ;;                     org-properties-value
   ;;                     org-special-keyword
   ;;                     org-src
   ;;                     org-tag
   ;;                     org-verbatim))
   ;;             (spell-fu-mode)))

   ;; (add-hook 'emacs-lisp-mode-hook
   ;;           (lambda ()
   ;;             (spell-fu-mode)))
#+END_SRC

*** Rectangles
:PROPERTIES:
:ID:       85B5D4E0-B5D3-408D-A41D-A2BC44E3F029
:END:
This is a hydra for working with the ~rectangle~ commands.

TODO: I should understand how this works better.

#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (my-leader-def "R" '(hydra-rectangle/body :wk "rectangle"))
  (defhydra hydra-rectangle (:body-pre (rectangle-mark-mode 1)
                                       :color pink
                                       :hint nil
                                       :post (deactivate-mark))
    "
      ^_i_^       _w_ copy      _O_pen       _N_umber-lines
    _n_   _o_     _y_ank        _t_ype       _E_xchange-point
      ^_e_^       _d_ kill      _c_lear      _r_eset-region-mark
    ^^^^          _u_ndo        _q_uit       ^ ^
    "
    ("i" rectangle-previous-line)
    ("e" rectangle-next-line)
    ("n" rectangle-backward-char)
    ("o" rectangle-forward-char)
    ("d" kill-rectangle)                    ;; C-x r k
    ("y" yank-rectangle)                    ;; C-x r y
    ("w" copy-rectangle-as-kill)            ;; C-x r M-w
    ("O" open-rectangle)                    ;; C-x r o
    ("t" string-rectangle)                  ;; C-x r t
    ("c" clear-rectangle)                   ;; C-x r c
    ("E" rectangle-exchange-point-and-mark) ;; C-x C-x
    ("N" rectangle-number-lines)            ;; C-x r N
    ("r" (if (region-active-p)
             (deactivate-mark)
           (rectangle-mark-mode 1)))
    ("u" undo nil)
    ("q" nil))
#+END_SRC

*** Whitespace Removal
:PROPERTIES:
:ID:       C2594210-A96C-4018-93BD-0C18BAE953F5
:END:
[[https://github.com/lewang/ws-butler][~ws-butler~]] automatically removes trailing whitespace from lines that have been editted.

#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package ws-butler
    :config
    (ws-butler-global-mode))
#+END_SRC


*** Move to beginning of line
:PROPERTIES:
:ID:       E1E19C91-7B99-452A-8FB2-6AE35A2DF2CD
:END:
This snippet provides smarter moving to the beginning of the line. Copied from [[https://emacsredux.com/blog/2013/05/22/smarter-navigation-to-the-beginning-of-a-line/][EmacsRedux]].
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (defun smarter-move-beginning-of-line (arg)
    "Move point back to indentation of beginning of line.

    Move point to the first non-whitespace character on this line.
    If point is already there, move to the beginning of the line.
    Effectively toggle between the first non-whitespace character and
    the beginning of the line.

    If ARG is not nil or 1, move forward ARG - 1 lines first.  If
    point reaches the beginning or end of the buffer, stop there."
    (interactive "^p")
    (setq arg (or arg 1))

    ;; Move lines first
    (when (/= arg 1)
      (let ((line-move-visual nil))
        (forward-line (1- arg))))

    (let ((orig-point (point)))
      (back-to-indentation)
      (when (= orig-point (point))
        (move-beginning-of-line 1))))

  ;; remap C-a to `smarter-move-beginning-of-line'
  (general-define-key "C-a" 'smarter-move-beginning-of-line)
#+END_SRC

** Window Management
:PROPERTIES:
:ID:       33BDFB30-8D15-49B7-87EC-ED43951373DF
:END:

[[https://github.com/abo-abo/ace-window][~ace-window~]] allows for easy switching between windows within a frame, splitting windows and moving and
copying windows.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package ace-window
    :general
    ("C-x o" 'ace-window)
    :config
    (setq aw-keys '(?a ?r ?s ?t ?n ?e ?i ?o)))
#+END_SRC

[[https://github.com/dimitri/switch-window][~switch-window~]] allows for easy switching between windows within a frame. It's slightly better than
~ace-window~ for that basic task as the labels for the windows are larger. However, ~ace-window~ is
worth keeping around for other functionality.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package switch-window
    :general
    ("M-o" 'switch-window)
    :config
    (setq switch-window-shortcut-style 'qwerty))
#+END_SRC


[[https://www.gnu.org/software/emacs/manual/html_node/emacs/Window-Convenience.html#index-winner_002dmode][~winner-mode~]] tracks changes in window configuration for a frame so that they can be undone or
redone.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package winner
    :commands winner-mode
    :init (winner-mode t))
#+END_SRC

These are various functions for manipulating window size.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (defun hydra-move-splitter-left (delta)
    "Move window splitter left."
    (interactive "p")
    (let ((windmove-wrap-around nil))
      (if (windmove-find-other-window 'right)
          (shrink-window-horizontally delta)
        (enlarge-window-horizontally delta))))

  (defun hydra-move-splitter-right (delta)
    "Move window splitter right."
    (interactive "p")
    (let ((windmove-wrap-around nil))
      (if (windmove-find-other-window 'right)
          (enlarge-window-horizontally delta)
        (shrink-window-horizontally delta))))

  (defun hydra-move-splitter-up (delta)
    "Move window splitter up."
    (interactive "p")
    (let ((windmove-wrap-around nil))
      (if (windmove-find-other-window 'up)
          (enlarge-window delta)
        (shrink-window delta))))

  (defun hydra-move-splitter-down (delta)
    "Move window splitter down."
    (interactive "p")
    (let ((windmove-wrap-around nil))
      (if (windmove-find-other-window 'up)
          (shrink-window delta)
        (enlarge-window delta))))
#+END_SRC

Now we've got a hydra to make the various window management functions easily accessible.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (defhydra hydra-window-delux (:hint nil)
    "
      ^Movement^        ^Split^          ^Switch^            ^Resize^
      -------------------------------------------------------------------
      _n_ ←             _r_ight          _b_uffer            _l_ X←
      _e_ ↓             _d_own           _f_ind files        _u_ X↓
      _i_ ↑             _z_ undo         _a_ce 1             _y_ X↑
      _o_ →             _Z_ reset        _s_wap              _'_ X→
      _F_ollow          _D_lt Other      ^ ^                 _m_aximize
      _q_ quit          _O_nly this      _c_lose             _=_ balance
      "
    ;; Movement
    ("n" windmove-left )
    ("e" windmove-down )
    ("i" windmove-up )
    ("o" windmove-right )
    ("F" follow-mode)

    ;; Resize
    ("l" hydra-move-splitter-left)
    ("u" hydra-move-splitter-down)
    ("y" hydra-move-splitter-up)
    ("'" hydra-move-splitter-right)
    ("m" ace-maximize-window)
    ("=" balance-windows)

    ;; Split
    ("r" (lambda ()
           (interactive)
           (split-window-right)
           (windmove-right)))
    ("d" (lambda ()
           (interactive)
           (split-window-below)
           (windmove-down)))
    ("z" (progn
           (winner-undo)
           (setq this-command 'winner-undo)))
    ("Z" winner-redo)
    ("D" (lambda ()
           (interactive)
           (ace-window 16)
           (add-hook 'ace-window-end-once-hook
                     'hydra-window/body)))
    ("O" delete-other-windows)

    ;; Switch
    ("b" consult-buffer)
    ("f" find-files)
    ("a" (lambda ()
           (interactive)
           (ace-window 1)
           (add-hook 'ace-window-end-once-hook
                     'hydra-window/body)))
    ("s" (lambda ()
           (interactive)
           (ace-window 4)
           (add-hook 'ace-window-end-once-hook
                     'hydra-window/body)))
    ("c" delete-window)

    ("q" nil))
  (my-leader-def
    "w" '(hydra-window-delux/body :wk "windows"))
#+END_SRC

** Software Development
*** Treesitter Setup
:PROPERTIES:
:ID:       199394FB-985F-4076-BEF4-2A3139FFFCB9
:END:
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package emacs
    :config
    ;; Treesitter config
    (setq treesit-language-source-alist
  	'((bash "https://github.com/tree-sitter/tree-sitter-bash")
  	  (cmake "https://github.com/uyha/tree-sitter-cmake")
  	  (css "https://github.com/tree-sitter/tree-sitter-css")
  	  (elisp "https://github.com/Wilfred/tree-sitter-elisp")
  	  (go "https://github.com/tree-sitter/tree-sitter-go")
  	  (gomod "https://github.com/camdencheek/tree-sitter-go-mod")
  	  (dockerfile "https://github.com/camdencheek/tree-sitter-dockerfile")
  	  (html "https://github.com/tree-sitter/tree-sitter-html")
  	  (javascript "https://github.com/tree-sitter/tree-sitter-javascript" "master" "src")
  	  (json "https://github.com/tree-sitter/tree-sitter-json")
  	  (make "https://github.com/alemuller/tree-sitter-make")
  	  (markdown "https://github.com/ikatyang/tree-sitter-markdown")
  	  (python "https://github.com/tree-sitter/tree-sitter-python")
  	  (toml "https://github.com/tree-sitter/tree-sitter-toml")
  	  (tsx "https://github.com/tree-sitter/tree-sitter-typescript" "master" "tsx/src")
  	  (typescript "https://github.com/tree-sitter/tree-sitter-typescript" "master" "typescript/src")
  	  (yaml "https://github.com/ikatyang/tree-sitter-yaml")))
    ;; Tell Emacs to prefer the treesitter mode
    ;; You'll want to run the command `M-x treesit-install-language-grammar' before editing.
    (setq major-mode-remap-alist
  	'((yaml-mode . yaml-ts-mode)
  	  (bash-mode . bash-ts-mode)
  	  (go-mode . go-ts-mode)
  	  (js2-mode . js-ts-mode)
  	  (typescript-mode . typescript-ts-mode)
  	  (json-mode . json-ts-mode)
  	  (css-mode . css-ts-mode)
  	  (python-mode . python-ts-mode)))
    )

  (use-package expreg
    :general
    ("M-<" 'expreg-contract)
    ("M->" 'expreg-expand))
#+END_SRC
*** Git
:PROPERTIES:
:ID:       D2862523-93E3-4F58-B975-0AAB2F0955FA
:END:
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package magit
    :general
    ("C-x g" 'magit-status)
    (my-leader-def
      "g" '(hydra-my-git-menu/body :wk "git"))
    :config
    ;; This sets Magit to use the fullframe
    ;; (setq magit-display-buffer-function #'magit-display-buffer-fullframe-status-v1)
    (defun my/magit-yank-branch-name ()
      "Show the current branch in the echo-area and add it to the `kill-ring'."
      (interactive)
      (let ((branch (magit-get-current-branch)))
        (if branch
            (progn (kill-new branch)
                   (message "%s" branch))
          (user-error "There is not current branch")))))
#+END_SRC

[[https://github.com/dandavison/magit-delta][~magit-delta~]] enables improved diffs for Magit using [[https://github.com/dandavison/delta][delta]].

I've disabled this for now since it seemed a bit slow.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package magit-delta
    :disabled
    :hook (magit-mode . magit-delta-mode))
#+END_SRC
[[https://github.com/emacsmirror/git-timemachine][~git-timemachine~]] allows you to walk through Git revisions of a file to view changes over time.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package git-timemachine
    :defer t)
#+END_SRC

[[https://github.com/redguardtoo/vc-msg][~vc-msg~]] shows a popup containing the commit message that last affected the current line.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package vc-msg
    :defer t)
#+END_SRC

[[https://github.com/dgutov/diff-hl][~diff-hl~]] shows icons on the buffer fringe for lines that have been added, removed or
modified.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package diff-hl
    :hook (magit-post-refresh . diff-hl-magit-post-refresh)
    :config
    (diff-hl-flydiff-mode)
    (global-diff-hl-mode))
    #+END_SRC

[[https://github.com/rmuslimov/browse-at-remote][~browse-at-remote~]] allows for quick jumping to the relevant Github (or whatever) page corresponding
to the current file.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package browse-at-remote)
 #+END_SRC

A nice Hydra menu to make things more accessible.
  #+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
    (defhydra hydra-my-git-menu (:color blue
                                        :hint nil)
      "
              ^Navigate^        ^Action^               ^Info^
              ^^^^^^^^^^^^---------------------------------------------------
              _n_: next hunk    _s_: stage hunk        _d_: diff
              _p_: prev hunk    _S_: stage file        _c_: show commit
              ^ ^               _U_: unstage file      _g_: magit status
              ^ ^               ^ ^                    _t_: git timemachine
              _r_: browse at remote                  _b_: yank branch name
              "
      ("n" diff-hl-next-hunk :color red)
      ("p" diff-hl-previous-hunk :color red)
      ("s" diff-hl-stage-current-hunk)
      ("S" magit-stage-file)
      ("U" magit-unstage-file)
      ("c" vc-msg-show :color red)
      ("g" magit-status :exit t)
      ("d" magit-diff-buffer-file)
      ("t" git-timemachine :exit t)
      ("b" my/magit-yank-branch-name :exit t)
      ("r" browse-at-remote)
      ("q" nil :exit t))

    (defhydra hydra-my-git-timemachine-menu (:color blue)
      ("s" git-timemachine "start")
      ("j" git-timemachine-show-next-revision "next revision")
      ("k" git-timemachine-show-previous-revision "prev revision")
      ("c" git-timemachine-show-current-revision "curr revision")
      ("<ESC>" git-timemachine-show-current-revision "quit" :exit t))
#+END_SRC

*** Flycheck
:PROPERTIES:
:ID:       ED7011C9-4F36-493B-9E80-BB3FF232FF5E
:END:
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package flycheck
    :general
    (my-leader-def
      "f" '(hydra-flycheck-mode/body :wk "flycheck"))
    :config
    (global-flycheck-mode +1)
    :hydra
    (hydra-flycheck-mode
     (:hint nil
            :color green
            :pre (flycheck-list-errors)
            :post (quit-windows-on "*Flycheck errors*"))
     "
  Find Errors        Describe Errors
  -----------------------------------
  _f_irst error      _s_how error
  _n_ext error       _e_xplain error
  _p_rev error       ^ ^
  _l_ist errors      _q_uit
  "
     ("f" flycheck-first-error)
     ("n" flycheck-next-error)
     ("p" flycheck-previous-error)
     ("l" flycheck-list-errors)
     ("s" flycheck-display-error-at-point)
     ("e" flycheck-explain-error-at-point)
     ("q" nil :exit t)))

  (use-package flycheck-eglot
    :after (flycheck eglot)
    :custom (flycheck-eglot-exclusive nil)
    :config
    (global-flycheck-eglot-mode 1))

  (use-package flycheck-golangci-lint
    :after (flycheck)
    :hook (go-ts-mode . flycheck-golangci-lint-setup)
    :config
    (setq flycheck-golangci-lint-tests t))
#+END_SRC
*** LSP Servers
:PROPERTIES:
:ID:       482ED4FE-7F7F-4D0E-A3F3-14CEC5372337
:END:

#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package eglot
    :straight nil
    :hook
    ((go-ts-mode . eglot-ensure)
     (python-ts-mode . eglot-ensure)
     (sh-mode . eglot-ensure))
    :custom
    (eglot-send-changes-idle-time 0.1)
    ;; activate Eglot in referenced non-project files
    (eglot-extend-to-xref t)
    :config
    ;; massive perf boost---don't log every event
    (fset #'jsonrpc--log-event #'ignore))
#+END_SRC

*** Particular Programming modes
:PROPERTIES:
:ID:       8DE130F8-A158-4350-A02F-C99A2EC9A288
:END:
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package markdown-mode
    :hook ((markdown-mode . visual-line-mode)))

  (use-package yaml-mode)

  (use-package json-mode)

  (use-package go-ts-mode
    :hook
    (before-save . eglot-format))

  (use-package sh-script)

  (use-package terraform-mode
    :config
    (setq terraform-format-on-save t))
#+END_SRC

These packages need to be installed in the Python environment too.
#+BEGIN_SRC sh
 pip install "python-lsp-server[all]" pylsp-mypy pylsp-rope python-lsp-ruff python-lsp-black
#+END_SRC

#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package pyvenv)
#+END_SRC

** Yasnippets
:PROPERTIES:
:ID:       1A54EDBC-D408-4843-8028-CEE653B9E440
:END:
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package yasnippet
    :config
    (yas-global-mode +1)
    (setq yas-snippet-dirs (append yas-snippet-dirs
  				 '("~/.emacs.d/snippets/"))))

  (use-package yasnippet-snippets
    :after yasnippet)
#+END_SRC

*** Snippets
These are various snippets for use with Yasnippet.
#+BEGIN_SRC :tangle "~/.emacs.d/snippets/go-mode/ifen" :eval no :mkdirp yes
# -*- mode: snippet -*-
# name: if error nil
# key: ifen
# --
if err != nil {
  $1
}
#+END_SRC

*** Kubernetes
:PROPERTIES:
:ID:       664E2A07-1DA8-4255-892E-565438153A71
:END:
#+begin_src emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package kele
    :config
    (kele-mode 1))

  (use-package kubernetes
    :commands (kubernetes-overview)
    :config
    (setq kubernetes-poll-frequency 3600
          kubernetes-redraw-frequency 3600))
#+end_src

** Org
See helpful examples at:
- http://doc.norang.ca/org-mode.html

*** Setup
:PROPERTIES:
:ID:       F8105CAC-7798-4FA9-99AD-A946940C527A
:END:
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package org
    :general
    ("C-c l" 'org-store-link)
    ;; This conflicts with Avy
    (org-mode-map "C-'" nil)

    :config
    (setq org-agenda-files my/org-agenda-files
          org-directory my/org-dir
          org-tags-column 75
          org-log-into-drawer t ;; hide the log state change history a bit better
          org-hide-emphasis-markers t ;;TODO ignore emphasis markers on kill?
          org-log-done t
          org-id-link-to-org-use-id t
          org-deadline-warning-days 7
          org-agenda-skip-scheduled-if-deadline-is-shown t
          org-agenda-start-with-log-mode t
          org-habit-graph-column 65
          org-archive-location "archive.org::datetree/"
          org-duration-format 'h:mm ;; show hours at max, not days
          org-agenda-compact-blocks t
          org-cycle-separator-lines 0
          ;; hide empty agenda sections
          org-agenda-clockreport-parameter-plist '(:stepskip0 t :link t :maxlevel 2 :fileskip0 t)
          org-structure-template-alist (append
                                        org-structure-template-alist
                                        '(("not" . "note")
                                          ("m" . "export markdown")))
          ;; default show today
          org-agenda-span 'day
          org-agenda-start-day "-0d"
          org-agenda-start-on-weekday 1
          org-agenda-custom-commands
          '(("d" "Done tasks" tags "/DONE|CANCELED")
            ("g" "Plan Today"
             ((agenda "" ((org-agenda-span 'day)))
              (org-agenda-skip-function '(org-agenda-skip-deadline-if-not-today))
              (org-agenda-entry-types '(:deadline))
              (org-agenda-overriding-header "Today's Deadlines "))))))
#+END_SRC

#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package org-appear
    :hook (org-mode . org-appear-mode))
#+END_SRC

[[https://github.com/minad/org-modern][~org-modern~]] gives ~org-mode~ a more modern style.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package org-modern
    :config
    (global-org-modern-mode))
#+END_SRC


[[https://github.com/calvinwyoung/org-autolist][~org-autolist~]] modifies the way ~RET~ works when inserting lists to make it a bit more intuitive.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package org-autolist
    :hook (org-mode . org-autolist-mode))
#+END_SRC

*** Task States
:PROPERTIES:
:ID:       6E3FBBD2-310E-4EDF-8EA3-CA9C4AA56F08
:END:
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (setq org-todo-keywords
      '((sequence "TODO(t)"
                  "PLANNING(p)"
                  "IN-PROGRESS(i@/!)"
                  "VERIFYING(v!)"
                  "BLOCKED(b@)"
                  "WAITING(w@)"
                  "|"
                  "DONE(d!)"
                  "CANCELLED(c@)"
                  "OBE(o@)"
                  "WONT-DO(n@/!)")))
#+END_SRC

*** Tags
:PROPERTIES:
:ID:       23040127-1D67-4725-90FE-22183BE585E9
:END:
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (setq org-tag-alist '(
                        ;; Task types
                        (:startgroup . nil)
                        ("email" . ?e)
                        ("design" . ?d)
                        ("implementation" . ?M)
                        ("improvement" . ?r)
                        ("investigation" . ?v)
                        (:endgroup . nil)

                        ;; Meeting types
                        (:startgroup . nil)
                        ("weekly_setup" . ?S)
                        ("weekly_wrap_up" . ?W)
                        ("1_to_1" . ?1)
                        (:endgroup . nil)

                        ;; Code TODOs tags
                        ("questionable_code" . ?q)
                        ("refactor" . ?F)

                        ;; Special tags
                        ("CRITICAL" . ?c)

                        ;; Meeting tags
                        ("meeting" . ?m)

                        ;; Work Log Tags
                        ("accomplishment" . ?A)
                        ))
#+END_SRC

*** Capture Templates
:PROPERTIES:
:ID:       FEDA9815-5C33-42E4-BE74-EE2C99A79184
:END:

#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package org-capture
    :straight nil
    :general
    (my-leader-def
      "c" 'org-capture)
    :config
    (setq org-refile-targets '((nil :maxlevel . 9)
                               (org-agenda-files :maxlevel . 9))
          ;; Refile in a single go
          org-outline-path-complete-in-steps nil
          ;; Show full paths for refiling
          org-refile-use-outline-path t
          org-capture-templates
          '(
            ("c" "Note on current task" plain (clock) "\n\n%T from: %a\n%i\n%?")

            ("g" "General To-Do"
             entry (file+headline "~/notebook/refile.org" "General Tasks")
             "* TODO [#B] %?\n:Created: %T\n "
             :empty-lines 0)

            ("s" "Source code To-Do"
             entry (file+headline "~/notebook/refile.org" "Code Related Tasks")
             "* TODO [#B] %?\n:Created: %T\n\nFrom [[file:%(org-capture-get :original-file)::%(at/get-capture-line-number)][%(org-capture-get :original-file-nondirectory):%(at/get-capture-line-number)]]:\n#+BEGIN_SRC\n%(at/get-capture-region-or-line-content)\n#+END_SRC\n\nIssue:\n"
             :empty-lines 0)

            ("n" "General Note"
             entry (file+headline "~/notebook/notes.org" "General Notes")
             "* %?\n:Created: %T\n "
             :empty-lines 0)

            ("m" "Meeting")

            ("ma" "Adhoc Meeting"
             entry (file+olp+datetree "~/notebook/meetings.org")
             "* %? :meeting:%^g \n:Created: %T\n** Attendees\n*** \n** Notes\n** Action Items\n*** TODO [#A] "
             :tree-type week
             :clock-in t
             :clock-resume t
             :empty-lines 0)

            )))

  (defun at/get-capture-line-number ()
    "Get the line number from the buffer that org-capture was called from."

    (with-current-buffer (org-capture-get :original-buffer) (number-to-string (line-number-at-pos))))

  (defun at/get-capture-region-or-line-content ()
    "Get the content of the active region or the current line from the buffer org-capture was called from."

    (if  (equal (plist-get org-store-link-plist :initial) "")
        (with-current-buffer (org-capture-get :original-buffer) (thing-at-point 'line t))
      (plist-get org-store-link-plist :initial)))

  ;; Heavily inspired by: https://emacs.stackexchange.com/questions/10597/how-to-refile-into-a-datetree
  (defun at/org-refile-to-datetree (&optional file date action)
    "Refile a subtree to a datetree corresponding to a date.
    If FILE is nil, refile in the current file. If DATE is nil
    refile using the entries timestamp or, failing that, the
    current time. If an ACTION expression is supplied execute it
    after pasting the subtree."

    ;; TODO: which timestamp do we actually want to use here?
    (let* ((datetree-date (or date
                              (org-entry-get nil "TIMESTAMP" t)
                              (org-read-date t nil "now")))
           (date (org-date-to-gregorian datetree-date)))
      (with-current-buffer (current-buffer)
        (save-excursion
          (org-cut-subtree)
          (if file (find-file file))
          (org-datetree-find-iso-week-create date)
          (org-narrow-to-subtree)
          (show-subtree)
          (org-end-of-subtree t)
          (newline)
          (goto-char (point-max))
          (org-paste-subtree 4)
          (if action (eval-expression action))
          (widen)))))

  (defun at/refile-to-meetings-at-date (date)
    "Refile a subtree to the supplied date in meetings.org"

    (interactive "sEnter date in yyyy-mm-dd format: ")
    (at/org-refile-to-datetree "meetings.org" date nil))

  (defun at/complete-regular-meeting (file-name template)
    "Mark the top-level headline in FILE-NAME as done, refile the
    entry to meetings.org and repopulate the file with the given
    template."

    (interactive)
    (unless
        (string= file-name buffer-file-name)
      (error "Function called from unexpected location"))
    (beginning-of-buffer)
    (org-todo "DONE")
    (at/org-refile-to-datetree "~/notebook/meetings.org" nil nil)
    (insert template))
#+END_SRC

*** Regular Meetings Example
This is an example of how I process regular meetings like 1 to 1s:
1. use the capture template below to gather agenda items during the week. These are accumulated into the 'My Agenda' heading in the given file.
2. during the meeting work through the agenda in the file
3. once the meeting is complete run ~at/complete-meeting-X~ which will refile the meeting into the main ~meetings.org~ file and setup a new empty template for the next one.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el" :tangle no

;; Add local capture settings to main list
(setq org-capture-templates (append
                             org-capture-templates
                             '(
                               ("mp" "Note for 1:1 with X"
                                 item (file+olp "~/notebook/regular_meetings/1_to_1_with_X.org" "1:1 with X" "My Agenda")
                                 "%i"
                                 :empty-lines 0)
                               )))

(defun at/complete-meeting-X ()
  "Go to the top level of the current entry, mark it as done, refile it and copy across a template for next time."

  (interactive)
  (at/complete-regular-meeting
   "/Users/andrew.thompson/notebook/regular_meetings/1_to_1_with_X.org"
   "* 1:1 with X :meeting:1_to_1:\n** My Agenda\n** Notes\n** Action Items"))
#+END_SRC


*** Agenda
:PROPERTIES:
:ID:       E9F8DE67-D355-430F-B93B-F57AE1D2E10F
:END:
[[https://github.com/alphapapa/org-super-agenda][~org-super-agenda~]] improves the existing ~org-agenda~ in various ways.

#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package org-super-agenda
    :after org-agenda
    :config
    (setq org-super-agenda-header-map nil)
    (org-super-agenda-mode))

  (setq org-agenda-custom-commands
        '(
          ("j" "Andrew's Super View"
           (
            (agenda ""
                    (
                     (org-agenda-remove-tags t)
                     (org-agenda-span 7)
                     )
                    )

            (alltodo ""
                     (
                      ;; Remove tags to make the view cleaner
                      (org-agenda-remove-tags t)
                      (org-agenda-prefix-format "  %t  %s")
                      (org-agenda-overriding-header "CURRENT STATUS")

                      ;; Define the super agenda groups (sorts by order)
                      (org-super-agenda-groups
                       '(
                         ;; Filter where tag is CRITICAL
                         (:name "Critical Tasks"
                                :tag "CRITICAL"
                                :order 0
                                )
                         ;; Filter where TODO state is IN-PROGRESS
                         (:name "Currently Working"
                                :todo "IN-PROGRESS"
                                :order 1
                                )
                         ;; Filter where TODO state is PLANNING
                         (:name "Planning Next Steps"
                                :todo "PLANNING"
                                :order 2
                                )
                         ;; Filter where TODO state is BLOCKED or where the tag is obstacle
                         (:name "Problems & Blockers"
                                :todo "BLOCKED"
                                :tag "obstacle"
                                :order 3
                                )
                         ;; Filter where tag is meeting and priority is A (only want TODOs from meetings)
                         (:name "Meeting Action Items"
                                :and (:tag "meeting" :priority "A")
                                :order 8
                                )
                         ;; Filter where state is TODO and the priority is A and the tag is not meeting
                         (:name "Other Important Items"
                                :and (:todo "TODO" :priority "A" :not (:tag "meeting"))
                                :order 9
                                )
                         ;; Filter where state is TODO and priority is B
                         (:name "General Backlog"
                                :and (:todo "TODO" :priority "B")
                                :order 10
                                )
                         ;; Filter where the priority is C or less (supports future lower priorities)
                         (:name "Non Critical"
                                :priority<= "C"
                                :order 11
                                )
                         ;; Filter where TODO state is VERIFYING
                         (:name "Currently Being Verified"
                                :todo "VERIFYING"
                                :order 20
                                )
                     ))))))))

  (defhydra hydra-org-agenda (:pre (setq which-key-inhibit t)
                                   :post (setq which-key-inhibit nil)
                                   :hint nil)
    "
    Org agenda (_q_uit)

    ^Clock^      ^Visit entry^              ^Date^             ^Other^
    ^-----^----  ^-----------^------------  ^----^-----------  ^-----^---------
    _ci_ in      _SPC_ in other window      _ds_ schedule      _gr_ reload
    _co_ out     _TAB_ & go to location     _dd_ set deadline  _._  go to today
    _cq_ cancel  _RET_ & del other windows  _dt_ timestamp     _gd_ go to date
    _cj_ jump    _o_   link                 _+_  do later      ^^
    ^^           ^^                         _-_  do earlier    ^^
    ^^           ^^                         ^^                 ^^
    ^View^          ^Filter^                 ^Headline^         ^Toggle mode^
    ^----^--------  ^------^---------------  ^--------^-------  ^-----------^----
    _vd_ day        _ft_ by tag              _ht_ set status    _tf_ follow
    _vw_ week       _fr_ refine by tag       _hk_ kill          _tl_ log
    _vt_ fortnight  _fc_ by category         _hr_ refile        _ta_ archive trees
    _vm_ month      _fh_ by top headline     _hA_ archive       _tA_ archive files
    _vy_ year       _fx_ by regexp           _h:_ set tags      _tr_ clock report
    _vn_ next span  _fd_ delete all filters  _hp_ set priority  _td_ diaries
    _vp_ prev span  ^^                       ^^                 ^^
    _vr_ reset      ^^                       ^^                 ^^
    ^^              ^^                       ^^                 ^^
    "
    ;; Entry
    ("hA" org-agenda-archive-default)
    ("hk" org-agenda-kill)
    ("hp" org-agenda-priority)
    ("hr" org-agenda-refile)
    ("h:" org-agenda-set-tags)
    ("ht" org-agenda-todo)
    ;; Visit entry
    ("o"   link-hint-open-link :exit t)
    ("<tab>" org-agenda-goto :exit t)
    ("TAB" org-agenda-goto :exit t)
    ("SPC" org-agenda-show-and-scroll-up)
    ("RET" org-agenda-switch-to :exit t)
    ;; Date
    ("dt" org-agenda-date-prompt)
    ("dd" org-agenda-deadline)
    ("+" org-agenda-do-date-later)
    ("-" org-agenda-do-date-earlier)
    ("ds" org-agenda-schedule)
    ;; View
    ("vd" org-agenda-day-view)
    ("vw" org-agenda-week-view)
    ("vt" org-agenda-fortnight-view)
    ("vm" org-agenda-month-view)
    ("vy" org-agenda-year-view)
    ("vn" org-agenda-later)
    ("vp" org-agenda-earlier)
    ("vr" org-agenda-reset-view)
    ;; Toggle mode
    ("ta" org-agenda-archives-mode)
    ("tA" (org-agenda-archives-mode 'files))
    ("tr" org-agenda-clockreport-mode)
    ("tf" org-agenda-follow-mode)
    ("tl" org-agenda-log-mode)
    ("td" org-agenda-toggle-diary)
    ;; Filter
    ("fc" org-agenda-filter-by-category)
    ("fx" org-agenda-filter-by-regexp)
    ("ft" org-agenda-filter-by-tag)
    ("fr" org-agenda-filter-by-tag-refine)
    ("fh" org-agenda-filter-by-top-headline)
    ("fd" org-agenda-filter-remove-all)
    ;; Clock
    ("cq" org-agenda-clock-cancel)
    ("cj" org-agenda-clock-goto :exit t)
    ("ci" org-agenda-clock-in :exit t)
    ("co" org-agenda-clock-out)
    ;; Other
    ("q" nil :exit t)
    ("gd" org-agenda-goto-date)
    ("." org-agenda-goto-today)
    ("gr" org-agenda-redo))

  (general-define-key
   :keymaps 'org-agenda-mode-map
   "." 'hydra-org-agenda/body)
#+END_SRC

*** Blocks
:PROPERTIES:
:ID:       FF254A72-BC0A-4F8E-B857-D72250D95EC7
:END:
Setup various ~org-mode~ structure templates. When typing ~<~ at the start of a line this will popup
a menu of various types of blocks that you may want to insert.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (defun my-org-structure-templates ()
    (require 'org-tempo)
    (add-to-list 'org-structure-template-alist '("el" . "src emacs-lisp"))
    (add-to-list 'org-structure-template-alist '("sh" . "src sh")))

  ;; todo this shuold be part of the org setup
  (defhydra hydra-org-template (:color blue :hint nil)
    "
   _c_enter  _Q_uote     _e_macs-lisp    _L_aTeX:
   _l_ink    _E_xample   _p_erl          _i_ndex:
   _a_scii   _v_erse     _m_arkdown      _I_NCLUDE:
   _s_rc     _n_ote      plant_u_ml      _H_TML:
   _h_tml    ^ ^         ^ ^             _A_SCII:
  "
    ("s" (hot-expand "<s"))
    ("E" (hot-expand "<e"))
    ("Q" (hot-expand "<q"))
    ("v" (hot-expand "<v"))
    ("n" (hot-expand "<not"))
    ("c" (hot-expand "<c"))
    ("l" (hot-expand "<li"))
    ("h" (hot-expand "<h"))
    ("a" (hot-expand "<a"))
    ("L" (hot-expand "<L"))
    ("i" (hot-expand "<i"))
    ("e" (hot-expand "<s" "emacs-lisp"))
    ("p" (hot-expand "<s" "perl"))
    ("u" (hot-expand "<s" "plantuml :file CHANGE.png"))
    ("m" (hot-expand "<m"))
    ("I" (hot-expand "<I"))
    ("H" (hot-expand "<H"))
    ("A" (hot-expand "<A"))
    ("<" self-insert-command "ins")
    ("q" nil "quit"))

  (require 'org-tempo) ; Required from org 9 onwards for old template expansion
  ;; Reset the org-template expnsion system, this is need after upgrading to org 9 for some reason
  (setq org-structure-template-alist (eval (car (get 'org-structure-template-alist 'standard-value))))
  (defun hot-expand (str &optional mod header)
    "Expand org template.

  STR is a structure template string recognised by org like <s. MOD is a
  string with additional parameters to add the begin line of the
  structure element. HEADER string includes more parameters that are
  prepended to the element after the #+HEADER: tag."
    (let (text)
      (when (region-active-p)
        (setq text (buffer-substring (region-beginning) (region-end)))
        (delete-region (region-beginning) (region-end))
        (deactivate-mark))
      (when header (insert "#+HEADER: " header) (forward-line))
      (insert str)
      (org-tempo-complete-tag)
      (when mod (insert mod) (forward-line))
      (when text (insert text))))

  (general-define-key
   :keymaps 'org-mode-map
   ;; disable this agenda key since I use it for avy
   "C-'" nil
   "<" '(lambda () (interactive)
          (if (or (region-active-p) (looking-back "^"))
              (hydra-org-template/body)
            (self-insert-command 1))))
#+END_SRC

*** Export Options
:PROPERTIES:
:ID:       32ED7961-A5B9-4EB0-B18D-BA3CF1D9B56A
:END:
[[https://github.com/hniksic/emacs-htmlize][~htmlize~]] converts a buffer to HTML with nice syntax highlighting.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package htmlize
    :defer t)
#+END_SRC

[[https://github.com/sshaw/copy-as-format][~copy-as-format~]] makes it easy to copy a region and convert the markup to a bunch of different
flavours for easy pasting into other places.
#+begin_src emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package copy-as-format
    :bind (("C-c w m" . copy-as-format-markdown)
           ("C-c w s" . copy-as-format-slack)
           ("C-c w o" . copy-as-format-org-mode)
           ("C-c w r" . copy-as-format-rst)
           ("C-c w g" . copy-as-format-github)
           ("C-c w w" . copy-as-format))
    :custom
    (copy-as-format-default "slack")
    :config
    (defun copy-as-format--org-mode (text _multiline)
      (format "#+begin_src %s\n%s\n#+end_src\n"
              (replace-regexp-in-string "-mode\\'" "" (symbol-name major-mode))
              text)))
#+end_src

[[https://github.com/titaniumbones/ox-slack][~ox-slack~]] is an ~org-mode~ exporter that converts text to Slack flavoured markdown.
#+begin_src emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package ox-slack
    :after org
    :bind
    ("C-c w k" . org-slack-export-to-clipboard-as-slack)
    :config
    (advice-add 'org-slack-export-to-clipboard-as-slack
                :after #'(lambda () (deactivate-mark))))
#+end_src

** Shells
:PROPERTIES:
:ID:       C357E950-E226-4B10-83AD-FD2EDEFE4781
:END:
[[https://github.com/akermu/emacs-libvterm][~vterm~]] provides a terminal emulator within Emacs.

There's a slight wrinkle here in that trying to add my prefix key, currently "C-t" to the list of
exceptions doesn't actually work. To get this to work I've needed to edit the actual ~vterm.el~ source
file and then rebuild the package and module.

Some interesting config options:
- https://github.com/jeffyql/dotfiles/blob/4484469d36e716dfe9431f1b489015423b63a91f/init-vterm.el

#+begin_src emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package vterm
    :general
    (my-leader-def "x" 'vterm-toggle)
    :config
    (setq vterm-max-scrollback 100000
          vterm-clear-scrollback t
          vterm-buffer-name-string "vterm-%s"
          vterm-keymap-exceptions
          '("M-:" "C-c" "C-x" "C-u" "C-g" "C-h" "C-l" "M-x" "M-o" "C-y" "M-y" "C-t" "M-s")))
#+end_src

#+begin_src emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package multi-vterm)
#+end_src

[[https://github.com/jixiuf/vterm-toggle][~vterm-toggle~]] allows for easy toggling of vterms.

TODO: get this setup to toggle a vterm in the directory of the current buffer and name the buffer
after the directory.
#+begin_src emacs-lisp :tangle "~/.emacs.d/init.el"
  (use-package vterm-toggle)
#+end_src
** Site Local
:PROPERTIES:
:ID:       07C27D9E-4EE9-424B-8D36-AD2FCE24B14E
:END:
Various setup like sensitive tags and functions that deal with them are stored elsewhere and loaded here.
#+BEGIN_SRC emacs-lisp :tangle "~/.emacs.d/init.el"
  (if (file-exists-p "~/notebook/local-dotfiles/site-local.el")
      (load "~/notebook/local-dotfiles/site-local.el"))
#+END_SRC

* Zsh
:PROPERTIES:
:ID:       9FCE7FDA-7FA3-47CE-B357-7443D0C92F44
:END:
I would quite like to use a Zsh plugin manager but there doesn't seem to be a clear winner in the
crowd and I can get by ok with a more home-brewed solution that basically uses ~cargo~ as a package
manager. The only real downside of this is that the initial setup eats a lot of CPU!

#+BEGIN_SRC shell :tangle "~/.zshrc"

  if ! command -v git &> /dev/null
  then
      echo "Git not present on system. Skipping local setup."
      exit
  fi

  # Enalbe syntax highlighting
  if [ ! -d "${HOME}/.zsh-syntax-highlighting/" ]; then
      echo "Installing Zsh syntax highlighting..."
      git clone https://github.com/zsh-users/zsh-syntax-highlighting.git ~/.zsh-syntax-highlighting
      source ~/.zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
  fi

  # Enable completions
  autoload -Uz compinit
  if [ ! -d "${HOME}/.zsh-completions/" ]; then
      echo "Installing Zsh completions..."
      git clone https://github.com/zsh-users/zsh-completions.git ~/.zsh-completions
      fpath=(path/to/zsh-completions/src $fpath)
  fi
  compinit

  # Install Rust
  if ! command -v cargo &> /dev/null
  then
      echo "Installing Rust..."
      curl https://sh.rustup.rs -sSf | sh -s -- -y --no-modify-path --default-toolchain stable --profile minimal
  fi

  # Install fzf. To update: cd ~/.fzf && git pull && ./install
  if ! command -v fzf &> /dev/null
  then
      echo "Installing fzf..."
      git clone --depth 1 https://github.com/junegunn/fzf.git ~/.fzf
      ~/.fzf/install
  fi
  [ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

  # Install zoxide
  if ! command -v zoxide &> /dev/null
  then
      echo "Installing zoxide..."
      cargo install zoxide --locked
  fi
  eval "$(zoxide init zsh)"

  # Install starship
  if ! command -v starship &> /dev/null
  then
      echo "Installing starship..."
      cargo install starship --locked
  fi
  eval "$(starship init zsh)"

  # Install atuin
  if ! command -v atuin &> /dev/null
  then
      echo "Installing atuin..."
      cargo install atuin
  fi
  eval "$(atuin init zsh)"

  # Install lsd
  if ! command -v lsd &> /dev/null
  then
      echo "Installing Nerd Fonts..."
      git clone --filter=blob:none --sparse git@github.com:ryanoasis/nerd-fonts ~/.nerd-fonts
      cd ~/.nerd-fonts
      git sparse-checkout add patched-fonts/FiraCode
      ./install.sh FiraCode
      echo "Don't forget to set this font in the terminal."

      echo "Installing lsd..."
      cargo install lsd
  fi

  alias ls='lsd --group-directories-first'
  alias l='ls -l'
  alias la='ls -a'
  alias ll='ls -la'
  alias lt='ls --tree'

  # Install bat
  if ! command -v bat &> /dev/null
  then
      echo "Installing bat..."
      cargo install bat --locked
  fi
  alias cat='bat'

  # Install zellij
  if ! command -v zellij &> /dev/null
  then
      echo "Installing zellij..."
      cargo install zellij --locked

      #TODO also install room plugin
  fi

  # Install ripgrep
  if ! command -v rg &> /dev/null
  then
      echo "Installing ripgrep..."
      cargo install ripgrep
  fi

  export PATH=${PATH}:~/.local/bin:~/bin:~/.cargo/bin
  #plugins=(history git common-aliases sudo emacs docker fasd you-should-use zsh-syntax-highlighting zsh-autosuggestions zsh-aliases-exa terraform ripgrep rust z)


  ################################################################################
  # Git aliases
  #
  alias g='git'
  alias gst='git status'
  alias ga='git add'
  alias gl='git pull'
  alias gcmsg='git commit --message'
  alias gco='git checkout'
  alias gs='git switch'
  alias gd='git diff'
  alias gdc='git diff --cached'
  alias gds='git diff --staged'
  alias glgg='git log --graph'
  alias glgga='git log --graph --decorate --all'
  alias glgm='git log --graph --max-count=10'
  alias glods='git log --graph --pretty="%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%ad) %C(bold blue)<%an>%Creset" --date=short'
  alias glod='git log --graph --pretty="%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%ad) %C(bold blue)<%an>%Creset"'
  alias glola='git log --graph --pretty="%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%ar) %C(bold blue)<%an>%Creset" --all'
  alias glols='git log --graph --pretty="%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%ar) %C(bold blue)<%an>%Creset" --stat'
  alias glol='git log --graph --pretty="%Cred%h%Creset -%C(auto)%d%Creset %s %Cgreen(%ar) %C(bold blue)<%an>%Creset"'
  alias glo='git log --oneline --decorate'
  alias glog='git log --oneline --decorate --graph'
  alias gloga='git log --oneline --decorate --graph --all'

  ###############################################################################
  # History settings
  #
  HISTSIZE=5000
  HISTFILE=~/.zsh_history
  SAVEHIST=100000
  unsetopt share_history
  unsetopt inc_append_history
  setopt append_history
  setopt inc_append_history_time
  setopt extended_history
  setopt longlistjobs

  ###############################################################################
  # Go
  #
  export GOPATH=${HOME}/go/
  export GO111MODULE=on
  export PATH=${PATH}:${GOPATH}bin

  ###############################################################################
  # Kubernetes
  #
  if command -v kubectl &> /dev/null
  then
      # CLI completion for kubectl/helm
      if [ $commands[kubectl] ]; then
          source <(kubectl completion zsh)
      fi

      if [ $commands[helm] ]; then
          source <(helm completion zsh)
      fi

      alias k='kubectl'
      alias kx="kubectx"
      alias kns="kubens"

      # Load individual kube contexts into $KUBECONFIG
      export KUBECONFIG="${HOME}/.kube/config"

      # Get Cmds
      alias kg='kubectl get'
      alias kgp='kubectl get pods'
      alias kgns='kubectl get namespaces'
      alias kgall='kubectl get ingress,service,deployment,pod'
      alias kgcj='kuebctl get cronjobs'
      alias kgj='kubectl get jobs'
      alias kctx=kubectx

      # Configuration cmds
      alias kuc='kubectl config use-context'
      alias ksc='kubectl config set-context "$(kubectl config current-context)"'

      # Networking
      alias kpf='kubectl port-forward'
      alias kp='kubectl proxy'
  fi

  alias u='ugrep'
  alias ..='cd ..'
  alias ...='cd ../..'

  export LANG="en_US.UTF-8"
  export PATH="/opt/homebrew/opt/libpq/bin:/opt/homebrew/opt/mysql-client/bin:$PATH"


  ###############################################################################
  # Functions
  #
  # Extract any given archive file
  extract() {
      if [[ -z "$1" ]]; then
          # display usage if no parameters given
          echo "Usage: extract <path/file_name>.<zip|rar|bz2|gz|tar|tbz2|tgz|Z|7z|xz|ex|tar.bz2|tar.gz|tar.xz>"
          echo "       extract <path/file_name_1.ext> [path/file_name_2.ext] [path/file_name_3.ext]"
          return 1
      else
          for n in $@
          do
              if [[ -f "$n" ]] ; then
                  case "${n%,}" in
                      ,*.tar.bz2|*.tar.gz|*.tar.xz|*.tbz2|*.tgz|*.txz|*.tar)
                          tar xvf "$n"       ;;
                      ,*.lzma)      unlzma ./"$n"      ;;
                      ,*.bz2)       bunzip2 ./"$n"     ;;
                      ,*.rar)       unrar x -ad ./"$n" ;;
                      ,*.gz)        gunzip ./"$n"      ;;
                      ,*.zip)       unzip ./"$n"       ;;
                      ,*.z)         uncompress ./"$n"  ;;
                      ,*.7z|*.arj|*.cab|*.chm|*.deb|*.dmg|*.iso|*.lzh|*.msi|*.rpm|*.udf|*.wim|*.xar)
                          7z x ./"$n"        ;;
                      ,*.xz)        unxz ./"$n"        ;;
                      ,*.exe)       cabextract ./"$n"  ;;
                      ,*)
                          echo "extract: '$n' - unknown archive method"
                          return 1
                          ;;
                  esac
              else
                  echo "'$n' - file does not exist"
                  return 1
              fi
          done
      fi
  }


  ###############################################################################
  # Compatibility with Emacs vterm.
  # See: https://github.com/akermu/emacs-libvterm
  #
  vterm_printf() {
      if [ -n "$TMUX" ] && ([ "${TERM%%-*}" = "tmux" ] || [ "${TERM%%-*}" = "screen" ]); then
          # Tell tmux to pass the escape sequences through
          printf "\ePtmux;\e\e]%s\007\e\\" "$1"
      elif [ "${TERM%%-*}" = "screen" ]; then
          # GNU screen (screen, screen-256color, screen-256color-bce)
          printf "\eP\e]%s\007\e\\" "$1"
      else
          printf "\e]%s\e\\" "$1"
      fi
  }

  vterm_cmd() {
      local vterm_elisp
      vterm_elisp=""
      while [ $# -gt 0 ]; do
          vterm_elisp="$vterm_elisp""$(printf '"%s" ' "$(printf "%s" "$1" | sed -e 's|\\|\\\\|g' -e 's|"|\\"|g')")"
          shift
      done
      vterm_printf "51;E$vterm_elisp"
  }

  vterm_prompt_end() {
      vterm_printf "51;A$(whoami)@$(hostname):$(pwd)"
  }
  setopt PROMPT_SUBST
  PROMPT=$PROMPT'%{$(vterm_prompt_end)%}'

  ZSH_THEME_TERM_TITLE_IDLE="%~"

  # source any site-local config
  if [ -f "${HOME}/notebook/local-dotfiles/zshrc" ]
  then
      source ~/notebook/local-dotfiles/zshrc
  fi
#+END_SRC


* Zellij
:PROPERTIES:
:ID:       0134A24C-061C-40A6-9957-A8A527147D46
:END:
#+BEGIN_SRC text :tangle "~/.config/zellij/config.kdl" :mkdirp yes
  // If you'd like to override the default keybindings completely, be sure to change "keybinds" to "keybinds clear-defaults=true"
  keybinds {
      // unbind C-g since I use it in Emacs a lot
      unbind "Ctrl g"
      normal {
          // uncomment this and adjust key if using copy_on_select=false
          // bind "Alt c" { Copy; }
      }
      locked {
          bind "Ctrl x" { SwitchToMode "Normal"; }
      }
      resize {
          bind "Ctrl n" { SwitchToMode "Normal"; }
          bind "h" "Left" { Resize "Increase Left"; }
          bind "j" "Down" { Resize "Increase Down"; }
          bind "k" "Up" { Resize "Increase Up"; }
          bind "l" "Right" { Resize "Increase Right"; }
          bind "H" { Resize "Decrease Left"; }
          bind "J" { Resize "Decrease Down"; }
          bind "K" { Resize "Decrease Up"; }
          bind "L" { Resize "Decrease Right"; }
          bind "=" "+" { Resize "Increase"; }
          bind "-" { Resize "Decrease"; }
      }
      pane {
          bind "Ctrl p" { SwitchToMode "Normal"; }
          bind "h" "Left" { MoveFocus "Left"; }
          bind "l" "Right" { MoveFocus "Right"; }
          bind "j" "Down" { MoveFocus "Down"; }
          bind "k" "Up" { MoveFocus "Up"; }
          bind "p" { SwitchFocus; }
          bind "n" { NewPane; SwitchToMode "Normal"; }
          bind "d" { NewPane "Down"; SwitchToMode "Normal"; }
          bind "r" { NewPane "Right"; SwitchToMode "Normal"; }
          bind "x" { CloseFocus; SwitchToMode "Normal"; }
          bind "f" { ToggleFocusFullscreen; SwitchToMode "Normal"; }
          bind "z" { TogglePaneFrames; SwitchToMode "Normal"; }
          bind "w" { ToggleFloatingPanes; SwitchToMode "Normal"; }
          bind "e" { TogglePaneEmbedOrFloating; SwitchToMode "Normal"; }
          bind "c" { SwitchToMode "RenamePane"; PaneNameInput 0;}
      }
      move {
          bind "Ctrl h" { SwitchToMode "Normal"; }
          bind "n" "Tab" { MovePane; }
          bind "p" { MovePaneBackwards; }
          bind "h" "Left" { MovePane "Left"; }
          bind "j" "Down" { MovePane "Down"; }
          bind "k" "Up" { MovePane "Up"; }
          bind "l" "Right" { MovePane "Right"; }
      }
      tab {
          bind "Ctrl t" { SwitchToMode "Normal"; }
          bind "r" { SwitchToMode "RenameTab"; TabNameInput 0; }
          bind "h" "Left" "Up" "k" { GoToPreviousTab; }
          bind "l" "Right" "Down" "j" { GoToNextTab; }
          bind "n" { NewTab; SwitchToMode "Normal"; }
          bind "x" { CloseTab; SwitchToMode "Normal"; }
          bind "s" { ToggleActiveSyncTab; SwitchToMode "Normal"; }
          bind "1" { GoToTab 1; SwitchToMode "Normal"; }
          bind "2" { GoToTab 2; SwitchToMode "Normal"; }
          bind "3" { GoToTab 3; SwitchToMode "Normal"; }
          bind "4" { GoToTab 4; SwitchToMode "Normal"; }
          bind "5" { GoToTab 5; SwitchToMode "Normal"; }
          bind "6" { GoToTab 6; SwitchToMode "Normal"; }
          bind "7" { GoToTab 7; SwitchToMode "Normal"; }
          bind "8" { GoToTab 8; SwitchToMode "Normal"; }
          bind "9" { GoToTab 9; SwitchToMode "Normal"; }
          bind "Tab" { ToggleTab; }
      }
      scroll {
          bind "Ctrl s" { SwitchToMode "Normal"; }
          bind "e" { EditScrollback; SwitchToMode "Normal"; }
          bind "s" { SwitchToMode "EnterSearch"; SearchInput 0; }
          bind "Ctrl c" { ScrollToBottom; SwitchToMode "Normal"; }
          bind "j" "Down" { ScrollDown; }
          bind "k" "Up" { ScrollUp; }
          bind "Ctrl f" "PageDown" "Right" "l" { PageScrollDown; }
          bind "Ctrl b" "PageUp" "Left" "h" { PageScrollUp; }
          bind "d" { HalfPageScrollDown; }
          bind "u" { HalfPageScrollUp; }
          // uncomment this and adjust key if using copy_on_select=false
          // bind "Alt c" { Copy; }
      }
      search {
          bind "Ctrl s" { SwitchToMode "Normal"; }
          bind "Ctrl c" { ScrollToBottom; SwitchToMode "Normal"; }
          bind "j" "Down" { ScrollDown; }
          bind "k" "Up" { ScrollUp; }
          bind "Ctrl f" "PageDown" "Right" "l" { PageScrollDown; }
          bind "Ctrl b" "PageUp" "Left" "h" { PageScrollUp; }
          bind "d" { HalfPageScrollDown; }
          bind "u" { HalfPageScrollUp; }
          bind "n" { Search "down"; }
          bind "p" { Search "up"; }
          bind "c" { SearchToggleOption "CaseSensitivity"; }
          bind "w" { SearchToggleOption "Wrap"; }
          bind "o" { SearchToggleOption "WholeWord"; }
      }
      entersearch {
          bind "Ctrl c" "Esc" { SwitchToMode "Scroll"; }
          bind "Enter" { SwitchToMode "Search"; }
      }
      renametab {
          bind "Ctrl c" { SwitchToMode "Normal"; }
          bind "Esc" { UndoRenameTab; SwitchToMode "Tab"; }
      }
      renamepane {
          bind "Ctrl c" { SwitchToMode "Normal"; }
          bind "Esc" { UndoRenamePane; SwitchToMode "Pane"; }
      }
      session {
          bind "Ctrl o" { SwitchToMode "Normal"; }
          bind "Ctrl s" { SwitchToMode "Scroll"; }
          bind "d" { Detach; }
      }
      tmux {
          bind "[" { SwitchToMode "Scroll"; }
          bind "Ctrl b" { Write 2; SwitchToMode "Normal"; }
          bind "\"" { NewPane "Down"; SwitchToMode "Normal"; }
          bind "%" { NewPane "Right"; SwitchToMode "Normal"; }
          bind "z" { ToggleFocusFullscreen; SwitchToMode "Normal"; }
          bind "c" { NewTab; SwitchToMode "Normal"; }
          bind "," { SwitchToMode "RenameTab"; }
          bind "p" { GoToPreviousTab; SwitchToMode "Normal"; }
          bind "n" { GoToNextTab; SwitchToMode "Normal"; }
          bind "Left" { MoveFocus "Left"; SwitchToMode "Normal"; }
          bind "Right" { MoveFocus "Right"; SwitchToMode "Normal"; }
          bind "Down" { MoveFocus "Down"; SwitchToMode "Normal"; }
          bind "Up" { MoveFocus "Up"; SwitchToMode "Normal"; }
          bind "h" { MoveFocus "Left"; SwitchToMode "Normal"; }
          bind "l" { MoveFocus "Right"; SwitchToMode "Normal"; }
          bind "j" { MoveFocus "Down"; SwitchToMode "Normal"; }
          bind "k" { MoveFocus "Up"; SwitchToMode "Normal"; }
          bind "o" { FocusNextPane; }
          bind "d" { Detach; }
          bind "Space" { NextSwapLayout; }
          bind "x" { CloseFocus; SwitchToMode "Normal"; }
      }
      shared_except "locked" {
          bind "Ctrl x" { SwitchToMode "Locked"; }
          bind "Ctrl q" { Quit; }
          bind "Alt n" { NewPane; }
          bind "Alt h" "Alt Left" { MoveFocusOrTab "Left"; }
          bind "Alt l" "Alt Right" { MoveFocusOrTab "Right"; }
          bind "Alt j" "Alt Down" { MoveFocus "Down"; }
          bind "Alt k" "Alt Up" { MoveFocus "Up"; }
          bind "Alt =" "Alt +" { Resize "Increase"; }
          bind "Alt -" { Resize "Decrease"; }
          bind "Alt [" { PreviousSwapLayout; }
          bind "Alt ]" { NextSwapLayout; }
          bind "Ctrl y" {
              LaunchOrFocusPlugin "file:~/.config/zellij/plugins/room.wasm" {
                  floating true
                  ignore_case true
              }
          }
      }
      shared_except "normal" "locked" {
          bind "Enter" "Esc" { SwitchToMode "Normal"; }
      }
      shared_except "pane" "locked" {
          bind "Ctrl p" { SwitchToMode "Pane"; }
      }
      shared_except "resize" "locked" {
          bind "Ctrl n" { SwitchToMode "Resize"; }
      }
      shared_except "scroll" "locked" {
          bind "Ctrl s" { SwitchToMode "Scroll"; }
      }
      shared_except "session" "locked" {
          bind "Ctrl o" { SwitchToMode "Session"; }
      }
      shared_except "tab" "locked" {
          bind "Ctrl t" { SwitchToMode "Tab"; }
      }
      shared_except "move" "locked" {
          bind "Ctrl h" { SwitchToMode "Move"; }
      }
      shared_except "tmux" "locked" {
          bind "Ctrl b" { SwitchToMode "Tmux"; }
      }
  }

  plugins {
      tab-bar { path "tab-bar"; }
      status-bar { path "status-bar"; }
      strider { path "strider"; }
      compact-bar { path "compact-bar"; }
  }

  // Choose what to do when zellij receives SIGTERM, SIGINT, SIGQUIT or SIGHUP
  // eg. when terminal window with an active zellij session is closed
  // Options:
  //   - detach (Default)
  //   - quit
  //
  on_force_close "detach"

  //  Send a request for a simplified ui (without arrow fonts) to plugins
  //  Options:
  //    - true
  //    - false (Default)
  //
  // simplified_ui true

  // Choose the path to the default shell that zellij will use for opening new panes
  // Default: $SHELL
  //
  // default_shell "fish"

  // Choose the path to override cwd that zellij will use for opening new panes
  //
  // default_cwd ""

  // Toggle between having pane frames around the panes
  // Options:
  //   - true (default)
  //   - false
  //
  pane_frames false

  // Toggle between having Zellij lay out panes according to a predefined set of layouts whenever possible
  // Options:
  //   - true (default)
  //   - false
  //
  // auto_layout true

  // Define color themes for Zellij
  // For more examples, see: https://github.com/zellij-org/zellij/tree/main/example/themes
  // Once these themes are defined, one of them should to be selected in the "theme" section of this file

  themes {
      dracula {
          fg 248 248 242
          bg 40 42 54
          black 0 0 0
          red 255 85 85
          green 80 250 123
          yellow 241 250 140
          blue 98 114 164
          magenta 255 121 198
          cyan 139 233 253
          white 255 255 255
          orange 255 184 108
      }
  }

  theme "dracula"

  // The name of the default layout to load on startup
  // Default: "default"
  //
  // default_layout "compact"

  // Choose the mode that zellij uses when starting up.
  // Default: normal
  //
  // default_mode "locked"

  // Toggle enabling the mouse mode.
  // On certain configurations, or terminals this could
  // potentially interfere with copying text.
  // Options:
  //   - true (default)
  //   - false
  //
  // mouse_mode false

  // Configure the scroll back buffer size
  // This is the number of lines zellij stores for each pane in the scroll back
  // buffer. Excess number of lines are discarded in a FIFO fashion.
  // Valid values: positive integers
  // Default value: 10000
  //
  // scroll_buffer_size 10000

  // Provide a command to execute when copying text. The text will be piped to
  // the stdin of the program to perform the copy. This can be used with
  // terminal emulators which do not support the OSC 52 ANSI control sequence
  // that will be used by default if this option is not set.
  // Examples:
  //
  // copy_command "xclip -selection clipboard" // x11
  // copy_command "wl-copy"                    // wayland
  // copy_command "pbcopy"                     // osx

  // Choose the destination for copied text
  // Allows using the primary selection buffer (on x11/wayland) instead of the system clipboard.
  // Does not apply when using copy_command.
  // Options:
  //   - system (default)
  //   - primary
  //
  // copy_clipboard "primary"

  // Enable or disable automatic copy (and clear) of selection when releasing mouse
  // Default: true
  //
  // copy_on_select false

  // Path to the default editor to use to edit pane scrollbuffer
  // Default: $EDITOR or $VISUAL
  //
  // scrollback_editor "/usr/bin/vim"

  // When attaching to an existing session with other users,
  // should the session be mirrored (true)
  // or should each user have their own cursor (false)
  // Default: false
  //
  // mirror_session true

  // The folder in which Zellij will look for layouts
  //
  // layout_dir "/path/to/my/layout_dir"

  // The folder in which Zellij will look for themes
  //
  // theme_dir "/path/to/my/theme_dir"
#+END_SRC

* Starship
:PROPERTIES:
:ID:       0C68921D-BD1C-4510-8F72-5AD0480CBA8C
:END:
[[https://starship.rs/][Starship]] is an easy way to get a decent shell prompt without much messing around.
#+BEGIN_SRC toml  :tangle "~/.config/starship.toml" :mkdirp yes
  # I include this so I can keep the dicrectory first, before the kubernetes context
  format = """
  $username\
  $hostname\
  $localip\
  $shlvl\
  $singularity\
  $directory\
  $vcsh\
  $fossil_branch\
  $fossil_metrics\
  $git_branch\
  $git_commit\
  $git_state\
  $git_metrics\
  $git_status\
  $hg_branch\
  $pijul_channel\
  $docker_context\
  $package\
  $c\
  $cmake\
  $cobol\
  $daml\
  $dart\
  $deno\
  $dotnet\
  $elixir\
  $elm\
  $erlang\
  $fennel\
  $golang\
  $guix_shell\
  $haskell\
  $haxe\
  $helm\
  $java\
  $julia\
  $kotlin\
  $gradle\
  $lua\
  $nim\
  $nodejs\
  $ocaml\
  $opa\
  $perl\
  $php\
  $pulumi\
  $purescript\
  $python\
  $raku\
  $rlang\
  $red\
  $ruby\
  $rust\
  $scala\
  $solidity\
  $swift\
  $terraform\
  $typst\
  $vlang\
  $vagrant\
  $zig\
  $buf\
  $nix_shell\
  $conda\
  $meson\
  $spack\
  $memory_usage\
  $aws\
  $gcloud\
  $openstack\
  $azure\
  $kubernetes\
  $direnv\
  $env_var\
  $crystal\
  $custom\
  $sudo\
  $cmd_duration\
  $line_break\
  $jobs\
  $battery\
  $time\
  $status\
  $os\
  $container\
  $shell\
  $character"""

  [aws]
  style = "bold #ffb86c"

  [character]
  error_symbol = "[λ](bold #ff5555)"
  success_symbol = "[λ](bold #50fa7b)"

  [cmd_duration]
  style = "bold #f1fa8c"

  [directory]
  style = "bold #50fa7b"

  [git_branch]
  style = "bold #ff79c6"

  [git_status]
  style = "bold #ff5555"

  [hostname]
  style = "bold #bd93f9"

  [username]
  format = "[$user]($style) on "
  style_user = "bold #8be9fd"

  [kubernetes]
  disabled = false
  format = 'in [$symbol$context( \($namespace\))]($style) '
  style = 'bold bright-red'

  [docker_context]
  disabled = false

  [time]
  disabled = false
#+END_SRC


* Atuin
:PROPERTIES:
:ID:       CAD617A3-6F3B-4C1D-80B8-A28C1B7B3BFB
:END:
[[https://github.com/atuinsh/atuin][~atuin~]] is a handy tool for keeping track of shell history.
#+BEGIN_SRC toml :tangle "~/.config/atuin/config.toml" :mkdirp yes
  dialect = "uk"
  style = "compact"
  inline_height = "10"
  enter_accept = "true"
#+END_SRC

